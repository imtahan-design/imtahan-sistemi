<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞mtahan.site - Real ƒ∞dar…ôetm…ô Paneli</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #00e676;
            --dark: #1e293b;
            --light: #f8fafc;
            --insta-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        h1 { color: var(--dark); margin: 0; }
        h2 { margin-top: 0; font-size: 1.2rem; color: #64748b; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        button.save-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .news-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .news-item:last-child { border-bottom: none; }
        .news-content h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .news-meta { font-size: 0.9rem; color: #64748b; }
        
        .insta-btn {
            background: var(--light); color: #444; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s; font-weight: 600;
        }
        .insta-btn:hover { background: var(--insta-gradient); color: white; border-color: transparent; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 39, 67, 0.3); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .server-status { padding: 10px; background: #fee2e2; color: #b91c1c; border-radius: 6px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .server-status.online { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>imtahan.site</h1>
            <span style="color:#64748b">Admin Panel (Server…ô qo≈üulur)</span>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="user-info" style="display:none; align-items:center; gap:8px; background:white; padding:8px 12px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <i class="fas fa-user-circle" style="color:var(--primary);"></i>
                <span id="user-email" style="font-size:0.9rem; font-weight:600;">user@email.com</span>
                <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:1.1rem;" title="√áƒ±xƒ±≈ü"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <button id="btn-login" class="save-btn" style="background:var(--primary);" onclick="showLoginModal()">
                <i class="fas fa-sign-in-alt"></i> Daxil Ol
            </button>
            
            <div id="status-indicator" class="server-status">
                <i class="fas fa-circle-xmark"></i> Server Offline (Serveri i≈ü…ô salƒ±n)
            </div>
            <button id="btn-start-server" class="save-btn" style="background:#16a34a;" onclick="startLocalServer()">
                <i class="fas fa-power-off"></i> Serveri Ba≈ülat
            </button>
            <button id="btn-restart-server" class="save-btn" style="background:#f59e0b;" onclick="restartServer()">
                <i class="fas fa-rotate-right"></i> Yenid…ôn Ba≈ülat
            </button>
        </div>
    </header>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
        <div class="card">
            <h2><i class="fas fa-pen-to-square"></i> Yeni X…ôb…ôr Yaz</h2>
            <div class="form-group">
                <label>Ba≈ülƒ±q</label>
                <input type="text" id="new-title" placeholder="X…ôb…ôr ba≈ülƒ±ƒüƒ±...">
            </div>
            <div class="form-group">
                <label>M…ôzmun</label>
                <textarea id="new-content" rows="4" placeholder="X…ôb…ôrin tam m…ôtni..." style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Kateqoriya</label>
                <select id="new-category" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                    <option value="R…ôsmi X…ôb…ôrl…ôr">R…ôsmi X…ôb…ôrl…ôr</option>
                    <option value="T…ôliml…ôr">T…ôliml…ôr</option>
                    <option value="M√ºsabiq…ôl…ôr">M√ºsabiq…ôl…ôr</option>
                    <option value="Texnoloji Yenilikl…ôr">Texnoloji Yenilikl…ôr</option>
                </select>
            </div>
            <button class="save-btn" onclick="addNews()">∆èlav…ô et</button>
            <button class="save-btn" style="background:#8b5cf6; margin-top: 10px;" onclick="updateSEO()">
                <i class="fas fa-search"></i> SEO Yenil…ô (Google √º√ß√ºn)
            </button>
        </div>

        <div class="card">
            <h2><i class="fas fa-newspaper"></i> X…ôb…ôrl…ôr Siyahƒ±sƒ±</h2>
            <div id="news-list">
                <div style="text-align: center; padding: 20px; color: #64748b;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>X…ôb…ôrl…ôr y√ºkl…ônir...</p>
                </div>
            </div>
        </div>
        
        <!-- SEARCH & EDIT SECTION -->
        <div style="margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
            <h3>üîç Sual Axtar v…ô D√ºz…ôli≈ü Et</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="search-q-text" placeholder="Axtarƒ±lacaq sual m…ôtni (v…ô ya hiss…ôsi)..." style="flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px;">
                <button onclick="searchQuestion()" id="btn-search-question" class="save-btn" style="background: #8b5cf6; min-width: 120px;">
                    <i class="fas fa-search"></i> Axtar
                </button>
            </div>
            <div id="search-results" style="display: grid; gap: 20px;"></div>
        </div>
    </div>

    <!-- TELEGRAM BOT SECTION -->
    <div class="card" style="grid-column: 1 / -1; margin-top: 0px; border-left: 5px solid #229ED9;">
        <h2 style="color: #229ED9;"><i class="fab fa-telegram"></i> Telegram Quiz Bot</h2>
        
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <!-- CONTROL PANEL -->
            <div style="flex: 1; min-width: 300px; padding-right: 20px; border-right: 1px solid #e2e8f0;">
                <h3>‚ö° S√ºr…ôtli ∆èm…ôliyyatlar</h3>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0 0 10px 0;"><strong>Status:</strong> <span style="color: green;">Aktiv</span></p>
                    <p style="margin: 0 0 10px 0;"><strong>Rejim:</strong> <span id="schedule-desc">12:00, 14:00, 16:00, 18:00, 20:00, 22:00, 00:00</span></p>
                    <p style="margin: 0; color: #d97706; font-weight: bold; font-size: 1.1em;">
                        <i class="far fa-clock"></i> N√∂vb…ôti: <span id="next-run-time">C…ôdv…ôl √ºzr…ô</span>
                    </p>
                </div>
                
                <h3>‚öôÔ∏è Konfiqurasiya</h3>
                <div class="form-group">
                    <label>Telegram Bot Token</label>
                    <input type="text" id="tg-token" placeholder="TELEGRAM_BOT_TOKEN">
                </div>
                <div class="form-group">
                    <label>Telegram Kanal ID</label>
                    <input type="text" id="tg-channel" placeholder="@kanal_adi v…ô ya ID">
                </div>
                <div class="form-group" style="margin-top: 15px; border-top: 1px solid #e2e8f0; paddingTop: 15px;">
                    <label>Google Analytics ID</label>
                    <input type="text" id="ga-id" placeholder="G-XXXXXXXXXX">
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">* D…ôyi≈üiklik edildikd…ôn sonra s…ôhif…ô yenil…ônm…ôlidir.</p>
                </div>
                <button id="btn-save-config" class="save-btn" style="background:#0ea5e9; width:100%; margin-bottom: 10px;" onclick="saveConfig()">
                    <i class="fas fa-save"></i> Konfiqurasiyanƒ± Saxla
                </button>
                <div id="config-status" style="font-size:0.9rem; color:#64748b; margin-bottom: 20px;"></div>
                
                <div class="form-group">
                    <label>Sual sayƒ±</label>
                    <input type="number" id="quiz-count" value="30" min="1" max="100" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                </div>
                
                <button onclick="startQuiz(parseInt(document.getElementById('quiz-count').value || '30', 10))" id="btn-start-quiz" class="save-btn" style="background: #229ED9; width: 100%; margin-bottom: 15px; padding: 15px;">
                    <i class="fas fa-rocket"></i> Quizi ƒ∞ndi Ba≈ülat (<span id="quiz-count-label">30</span> Sual)
                </button>
                <button onclick="stopQuiz()" id="btn-stop-quiz" class="save-btn" style="background: #ef4444; width: 100%; margin-bottom: 15px; padding: 12px;">
                    <i class="fas fa-stop"></i> Dayandƒ±r
                </button>
                <p id="quiz-count-note" style="font-size: 0.8rem; color: #64748b;">* Bu d√ºym…ô basƒ±landa Telegram kanalƒ±nda d…ôrhal 30 suallƒ±q sessiya ba≈ülayƒ±r.</p>
            </div>

            <!-- ADD QUESTION FORM -->
            <div style="flex: 2; min-width: 300px;">
                <h3>üìù Yeni Sual ∆èlav…ô Et</h3>
                <div class="form-group">
                    <label>Sual</label>
                    <input type="text" id="q-text" placeholder="Sualƒ±n m…ôtni..." style="width: 100%;">
                </div>
                
                <label>Variantlar</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="q-opt0" placeholder="Variant A">
                    <input type="text" id="q-opt1" placeholder="Variant B">
                    <input type="text" id="q-opt2" placeholder="Variant C">
                    <input type="text" id="q-opt3" placeholder="Variant D">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div class="form-group">
                        <label>D√ºzg√ºn Cavab</label>
                        <select id="q-correct" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <option value="0">Variant A</option>
                            <option value="1">Variant B</option>
                            <option value="2">Variant C</option>
                            <option value="3">Variant D</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ƒ∞zah (Cavabdan sonra g√∂r√ºn…ôc…ôk)</label>
                        <input type="text" id="q-explanation" placeholder="ƒ∞zah m…ôtni...">
                    </div>
                </div>
                
                <div class="form-group">
                     <label>Kateqoriya</label>
                     <input type="text" id="q-category" placeholder="M…ôs: Tarix, Coƒürafiya..." value="√úmumi">
                </div>

                <button onclick="addQuizQuestion()" id="btn-add-question" class="save-btn" style="background: #229ED9;">
                    <i class="fas fa-plus"></i> Sualƒ± Bazaya Yaz
                </button>
            </div>
        </div>
    </div>
</div>

<div id="startModal" class="modal">
  <div class="modal-content">
    <h3>Serveri ba≈ülatmaq √º√ß√ºn addƒ±mlar</h3>
    <div style="text-align:left; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-top:10px;">
      <div style="margin-bottom:8px;">1) Terminal a√ßƒ±n</div>
      <div style="margin-bottom:8px;">2) Qovluƒüa ke√ßin:</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <code style="background:#111827; color:#f9fafb; padding:6px 10px; border-radius:6px;">cd C:\Users\User\Desktop\Imtahan1</code>
        <button class="save-btn" style="padding:6px 10px;" onclick="copyText('cd C:\\\\Users\\\\User\\\\Desktop\\\\Imtahan1')">Kopyala</button>
      </div>
      <div style="margin:10px 0 8px;">3) Serveri i≈ü…ô salƒ±n:</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <code style="background:#111827; color:#f9fafb; padding:6px 10px; border-radius:6px;">node server.js</code>
        <button class="save-btn" style="padding:6px 10px;" onclick="copyText('node server.js')">Kopyala</button>
      </div>
    </div>
    <div style="margin-top:14px; display:flex; justify-content:center; gap:10px;">
      <button class="save-btn" onclick="closeStartModal()">Baƒüla</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">üîë Admin Giri≈üi</h3>
        <p style="color:#666; font-size:0.9rem;">D√ºz…ôli≈ü etm…ôk √º√ß√ºn hesabƒ±nƒ±za daxil olun.</p>
        <div class="form-group">
            <input type="email" id="login-email" placeholder="Email" style="width:100%; padding:12px;">
        </div>
        <div class="form-group">
            <input type="password" id="login-password" placeholder="≈ûifr…ô" style="width:100%; padding:12px;">
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button onclick="closeLoginModal()" class="save-btn" style="background:#cbd5e1; color:#333;">L…ôƒüv et</button>
            <button onclick="performLogin()" class="save-btn" style="background:var(--primary);">Daxil Ol</button>
        </div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAak_eY0WNpY7cqAEuWEBG9wBDhg1NPw_0",
        authDomain: "imtahansistemi-17659.firebaseapp.com",
        projectId: "imtahansistemi-17659",
        storageBucket: "imtahansistemi-17659.firebasestorage.app",
        messagingSenderId: "715396853166",
        appId: "1:715396853166:web:9829b853e5e572de4d2c3f"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const API_BASES = [];
    if (location.origin && /^https?:\/\//.test(location.origin)) { API_BASES.push(location.origin); }
    API_BASES.push('http://localhost:5000');
    API_BASES.push('http://127.0.0.1:5000');
    async function apiFetch(path, init) {
        let lastResp = null;
        for (const base of API_BASES) {
            try {
                const resp = await fetch(base + path, init);
                if (resp) {
                    // ∆èg…ôr 404 v…ô ya ba≈üqa x…ôta olsa bel…ô, …ôg…ôr bu bizim serverdirs…ô, davam edirik
                    if (resp.ok) return resp;
                    lastResp = resp;
                }
            } catch (e) {
                console.warn(`Fetch failed for ${base}:`, e);
            }
        }
        if (lastResp) return lastResp;
        throw new Error('Serverl…ô …ôlaq…ô qurmaq m√ºmk√ºn olmadƒ±. Z…ôhm…ôt olmasa terminalda "node server.js" komandasƒ±nƒ±n i≈ül…ôdiyini yoxlayƒ±n.');
    }

    // Serverin i≈ül…ôk olduƒüunu yoxlayaq
    // Auth State Observer
    firebase.auth().onAuthStateChanged((user) => {
        const loginBtn = document.getElementById('btn-login');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        if (user) {
            loginBtn.style.display = 'none';
            userInfo.style.display = 'flex';
            userEmail.textContent = user.email;
            console.log("User logged in:", user.email);
        } else {
            loginBtn.style.display = 'block';
            userInfo.style.display = 'none';
            console.log("User logged out");
        }
    });

    function showLoginModal() {
        document.getElementById('login-modal').style.display = 'flex';
    }

    function closeLoginModal() {
        document.getElementById('login-modal').style.display = 'none';
    }

    async function performLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        
        if (!email || !pass) {
            alert('Email v…ô ≈üifr…ôni daxil edin!');
            return;
        }

        try {
            await firebase.auth().signInWithEmailAndPassword(email, pass);
            closeLoginModal();
            alert('‚úÖ Uƒüurla daxil oldunuz!');
        } catch (error) {
            console.error(error);
            alert('‚ùå Giri≈ü x…ôtasƒ±: ' + error.message);
        }
    }

    async function logout() {
        try {
            await firebase.auth().signOut();
            alert('√áƒ±xƒ±≈ü edildi.');
        } catch (error) {
            console.error(error);
        }
    }

    async function checkServer() {
        const status = document.getElementById('status-indicator');
        try {
            // Saƒülamlƒ±q yoxlamasƒ±
            const response = await apiFetch('/health');
            const data = await response.json();
            
            if (data.status === 'online') {
                status.className = 'server-status online';
                status.innerHTML = `<i class="fas fa-check-circle"></i> Server Online (${data.instagram === 'connected' ? 'Instagram Baƒülƒ±dƒ±r' : 'Instagram Baƒülƒ± Deyil'})`;
            }
        } catch (e) {
            console.log("Server tapƒ±lmadƒ±");
            status.className = 'server-status';
            status.innerHTML = '<i class="fas fa-circle-xmark"></i> Server Offline (Serveri i≈ü…ô salƒ±n)';
        }
    }
    
    // S…ôhif…ô a√ßƒ±landa yoxla
    checkServer();
    setInterval(checkServer, 5000);
    
    // Real X…ôb…ôrl…ôri Y√ºkl…ô (Canlƒ± ƒ∞zl…ôm…ô il…ô)
    function loadRealNews() {
        db.collection('news').orderBy('date', 'desc').limit(20)
            .onSnapshot((snapshot) => {
                const list = document.getElementById('news-list');
                
                if (snapshot.empty) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px;">X…ôb…ôr tapƒ±lmadƒ±.</div>';
                    return;
                }

                list.innerHTML = ''; // T…ômizl…ô
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'news-item';
                    
                    // Vaxtƒ± formatla (…ôg…ôr timestamp formatƒ±ndadƒ±rsa)
                    let timeStr = 'Bilinmir';
                    if (data.date) {
                        try {
                             // Firebase Timestamp v…ô ya String ola bil…ôr
                             const date = data.date.toDate ? data.date.toDate() : new Date(data.date);
                             timeStr = date.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
                        } catch(e) { timeStr = data.date; }
                    }

                    // T…ôhl√ºk…ôsiz ba≈ülƒ±q v…ô m…ôzmun (quotes escape)
                    const escapeHtml = (str) => {
                        return (str || '')
                            .replace(/'/g, "\\'")     // JS string √º√ß√ºn t…ôk dƒ±rnaq
                            .replace(/"/g, "&quot;")  // HTML atributu √º√ß√ºn c√ºt dƒ±rnaq
                            .replace(/\n/g, "\\n");   // Yeni s…ôtir
                    };

                    const safeTitle = escapeHtml(data.title);
                    const safeContent = escapeHtml(data.content);

                    item.innerHTML = `
                        <div class="news-content">
                            <h3>${data.title}</h3>
                            <div class="news-meta">Kateqoriya: ${data.category} | ${timeStr}</div>
                        </div>
                        <button class="insta-btn" onclick="shareToInsta('${safeTitle}', '${safeContent}', this)">
                            <i class="fab fa-instagram"></i> Payla≈ü
                        </button>
                    `;
                    list.appendChild(item);
                });
            }, (error) => {
                console.error("X…ôb…ôrl…ôri y√ºkl…ôm…ôk m√ºmk√ºn olmadƒ±:", error);
                document.getElementById('news-list').innerHTML = `
                    <div style="color:red; text-align:center; padding:20px;">
                        X…ôb…ôrl…ôri y√ºkl…ôm…ôk m√ºmk√ºn olmadƒ±.<br>
                        <small>${error.message}</small>
                    </div>
                `;
            });
    }

    // X…ôb…ôrl…ôri dinl…ôm…ôy…ô ba≈üla
    loadRealNews();

    async function updateSEO() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SEO Yenil…ônir...';
        
        try {
            const response = await apiFetch('/api/admin/update-seo', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                btn.style.background = '#16a34a';
                btn.innerHTML = '<i class="fas fa-check"></i> SEO Hazƒ±rdƒ±r!';
                setTimeout(() => {
                    btn.style.background = '#8b5cf6';
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 3000);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error("SEO X…ôtasƒ±:", error);
            alert("‚ùå SEO yenil…ôm…ô x…ôtasƒ±: " + error.message);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    function slugify(str) {
        return (str || '')
            .toLowerCase()
            .replace(/ƒü/g,'g').replace(/…ô/g,'e').replace(/ƒ±/g,'i').replace(/√∂/g,'o').replace(/√ß/g,'c').replace(/≈ü/g,'s').replace(/√º/g,'u')
            .replace(/[^a-z0-9\s-]/g,'')
            .trim()
            .replace(/\s+/g,'-')
            .replace(/-+/g,'-')
            .slice(0, 120);
    }

    async function addNews() {
        const title = document.getElementById('new-title').value;
        const content = document.getElementById('new-content').value;
        const category = document.getElementById('new-category').value;
        const btn = document.querySelector('.save-btn');
        
        if(!title) {
            alert("Z…ôhm…ôt olmasa ba≈ülƒ±q yazƒ±n");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ∆èlav…ô edilir...';
        
        try {
            const slug = slugify(title);
            await db.collection('news').add({
                title: title,
                content: content,
                category: category,
                date: new Date().toISOString(), // Consistent with news-app.js
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                excerpt: content ? content.replace(/<[^>]+>/g, '').substring(0, 150) + '...' : title,
                tags: [],
                slug: slug,
                views: 0,
                status: 'published',
                readTime: Math.ceil((content || '').split(' ').length / 200) || 1
            });
            
            // Cache t…ômizl…ô ki, news s…ôhif…ôsind…ô d…ôrhal g√∂r√ºns√ºn
            sessionStorage.removeItem('news_list_cache');
            sessionStorage.removeItem('trend_news_cache');
            
            // Uƒüurlu
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value = '';
            btn.innerHTML = '<i class="fas fa-check"></i> ∆èlav…ô edildi';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '∆èlav…ô et';
            }, 2000);
            
            // QEYD: Siyahƒ±ya …ôl il…ô …ôlav…ô etmirik, √ß√ºnki onSnapshot bunu avtomatik ed…ôc…ôk!
        } catch (error) {
            console.error("X…ôta:", error);
            alert("X…ôta ba≈ü verdi: " + error.message);
            btn.disabled = false;
            btn.innerHTML = '∆èlav…ô et';
        }
    }

    async function shareToInsta(title, content, btn) {
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√∂nd…ôrilir...';
        btn.disabled = true;

        try {
            const response = await apiFetch('/share-to-instagram', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: title, content: content })
            });

            const result = await response.json();

            if (result.status === 'success') {
                btn.innerHTML = '<i class="fas fa-check"></i> Payla≈üƒ±ldƒ±!';
                btn.style.background = '#00e676';
                btn.style.color = 'white';
                
                // M√∂vcud ≈ü…ôkli sil (…ôg…ôr varsa)
                const existingImg = btn.parentNode.querySelector('.generated-post');
                if(existingImg) existingImg.remove();

                // Yeni ≈ü…ôkli g√∂st…ôr
                const img = document.createElement('img');
                img.src = 'http://localhost:5000/' + result.image;
                img.className = 'generated-post';
                img.style.maxWidth = '200px';
                img.style.marginTop = '15px';
                img.style.borderRadius = '8px';
                img.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                img.style.display = 'block';
                
                // D√ºym…ônin altƒ±na …ôlav…ô et
                const container = document.createElement('div');
                container.style.width = '100%';
                container.style.marginTop = '10px';
                container.appendChild(img);
                
                // Flex container olduƒüu √º√ß√ºn strukturu bir az d…ôyi≈üirik
                btn.parentNode.style.flexWrap = 'wrap';
                btn.parentNode.appendChild(container);

                alert(`‚úÖ Uƒüurla payla≈üƒ±ldƒ±!`);
            } else {
                alert('X…ôta: ' + result.error);
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        } catch (error) {
            alert('‚ùå Server…ô qo≈üulmaq olmadƒ±!\nZ…ôhm…ôt olmasa terminalda "python server.py" …ômrini i≈ül…ôdin.');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    async function startLocalServer() {
        const status = document.getElementById('status-indicator');
        try {
            const resp = await fetch('http://localhost:5000/health?t=' + Date.now(), { cache: 'no-store' });
            const data = await resp.json();
            if (data && data.status === 'online') {
                status.className = 'server-status online';
                status.innerHTML = `<i class="fas fa-check-circle"></i> Server Online (${data.instagram === 'connected' ? 'Instagram Baƒülƒ±dƒ±r' : 'Instagram Baƒülƒ± Deyil'})`;
                return;
            }
        } catch (e) {}
        document.getElementById('startModal').style.display = 'flex';
    }
    function closeStartModal() {
        document.getElementById('startModal').style.display = 'none';
    }
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {});
    }

    // TELEGRAM BOT FUNKSƒ∞YALARI
    async function restartServer() {
        const btn = document.getElementById('btn-restart-server');
        const status = document.getElementById('status-indicator');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yenid…ôn ba≈üladƒ±lƒ±r...';
        status.className = 'server-status';
        status.innerHTML = '<i class="fas fa-rotate-right"></i> Server yenid…ôn ba≈üladƒ±lƒ±r...';
        try {
            const resp = await apiFetch('/api/admin/restart-server', { method: 'POST' });
            const data = await resp.json();
            if (!data || !data.success) {
                throw new Error(data && data.message ? data.message : 'Nam…ôlum x…ôta');
            }
            // Online olana q…ôd…ôr yoxla
            const wait = (ms) => new Promise(r => setTimeout(r, ms));
            for (let i = 0; i < 20; i++) {
                await wait(1000);
                try {
                    const hr = await apiFetch('/health');
                    const hd = await hr.json();
                    if (hd && hd.status === 'online') {
                        status.className = 'server-status online';
                        status.innerHTML = `<i class="fas fa-check-circle"></i> Server Online (${hd.instagram === 'connected' ? 'Instagram Baƒülƒ±dƒ±r' : 'Instagram Baƒülƒ± Deyil'})`;
                        break;
                    }
                } catch (_) {}
            }
        } catch (e) {
            alert('X…ôta: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    }
    async function loadSchedule() {
        try {
            // Cache busting √º√ß√ºn timestamp …ôlav…ô edildi
            const response = await fetch('http://localhost:5000/api/telegram/schedule?t=' + new Date().getTime());
            const data = await response.json();
            
            // Rejim t…ôsvirini yenil…ô
            if (data.description) {
                document.getElementById('schedule-desc').innerText = data.description;
            }
            if (data.count != null && document.getElementById('quiz-count')) {
                document.getElementById('quiz-count').value = data.count;
                updateQuizCountViews(data.count);
            }

            // N√∂vb…ôti vaxtƒ± g√∂st…ôr (∆èg…ôr varsa)
            if (data.nextRun) {
                const date = new Date(data.nextRun);
                const timeStr = date.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
                const dayStr = date.toLocaleDateString('az-AZ', { day: 'numeric', month: 'long' });
                document.getElementById('next-run-time').innerHTML = `${timeStr} <span style="font-size:0.8em; color:#666">(${dayStr})</span>`;
            } else {
                // ∆èg…ôr nextRun yoxdursa (yeni API formatƒ±), sad…ôc…ô "Aktiv" yaz
                document.getElementById('next-run-time').innerText = "C…ôdv…ôl aktivdir";
            }
        } catch (error) {
            console.error("Schedule error:", error);
            document.getElementById('next-run-time').innerText = "Serverl…ô …ôlaq…ô yoxdur";
        }
    }

    // S…ôhif…ô y√ºkl…ôn…ônd…ô c…ôdv…ôli yoxla
    window.addEventListener('load', loadSchedule);
    // H…ôr d…ôqiq…ô yenil…ô
    setInterval(loadSchedule, 60000);

    function updateQuizCountViews(val) {
        const n = parseInt(val || '30', 10);
        const safe = isNaN(n) ? 30 : Math.max(1, Math.min(100, n));
        const lbl = document.getElementById('quiz-count-label');
        const note = document.getElementById('quiz-count-note');
        if (lbl) lbl.textContent = String(safe);
        if (note) note.textContent = `* Bu d√ºym…ô basƒ±landa Telegram kanalƒ±nda d…ôrhal ${safe} suallƒ±q sessiya ba≈ülayƒ±r.`;
    }
    const qcInput = document.getElementById('quiz-count');
    if (qcInput) {
        qcInput.addEventListener('input', (e) => updateQuizCountViews(e.target.value));
        updateQuizCountViews(qcInput.value);
    }
    // Configuration Logic
    async function loadConfig() {
        if (!db) return;
        
        try {
            const doc = await db.collection('config').doc('main').get();
            if (doc.exists) {
                const data = doc.data();
                if(document.getElementById('tg-token')) document.getElementById('tg-token').value = data.telegram_bot_token || '';
                if(document.getElementById('tg-channel')) document.getElementById('tg-channel').value = data.telegram_channel_id || '';
                if(document.getElementById('ga-id')) document.getElementById('ga-id').value = data.google_analytics_id || '';
            }
        } catch (error) {
            console.error("Config load error:", error);
        }
    }

    // Initial load
    window.addEventListener('load', loadConfig);

    async function saveConfig() {
        const btn = document.getElementById('btn-save-config');
        const status = document.getElementById('config-status');
        const token = document.getElementById('tg-token').value.trim();
        const channelId = document.getElementById('tg-channel').value.trim();
        const gaId = document.getElementById('ga-id') ? document.getElementById('ga-id').value.trim() : '';
        
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saxlanƒ±r...';
        status.innerHTML = '';
        
        try {
            // 1. Save to Firestore
            if (db) {
                await db.collection('config').doc('main').set({
                    telegram_bot_token: token,
                    telegram_channel_id: channelId,
                    google_analytics_id: gaId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }

            // 2. Update Local Server (Telegram Bot)
            const payload = { quizCount: parseInt(document.getElementById('quiz-count').value || '30', 10) };
            if (token) payload.token = token;
            if (channelId) payload.channelId = channelId;
            
            // Only call API if we are likely connected to the local server
            // But we can try anyway
            try {
                const resp = await apiFetch('/api/admin/telegram-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (!data || !data.success) {
                    console.warn('Local server config update failed:', data);
                }
            } catch(e) {
                console.warn('Local server not reachable for config update');
            }

            status.innerHTML = '<span style="color: green;"><i class="fas fa-check"></i> Saxlandƒ±!</span>';
        } catch (e) {
            console.error(e);
            status.innerHTML = '<span style="color: red;">X…ôta: ' + e.message + '</span>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    }

    // Legacy support alias
    async function saveTelegramConfig() { saveConfig(); }

    async function startQuiz(count) {
        const btn = document.getElementById('btn-start-quiz');
        const originalText = btn.innerHTML;
        
        if (!confirm(`${count} suallƒ±q quiz sessiyasƒ±nƒ± ba≈ülatmaq ist…ôdiyiniz…ô …ôminsiniz?`)) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ba≈üladƒ±lƒ±r...';

        try {
            const response = await apiFetch('/api/telegram/start-quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ count: count })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert("‚úÖ Quiz sessiyasƒ± uƒüurla ba≈üladƒ±!");
            } else {
                alert("‚ùå X…ôta: " + result.message);
            }
        } catch (error) {
            console.error(error);
            alert("‚ùå Serverl…ô …ôlaq…ô qurmaq m√ºmk√ºn olmadƒ±.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function stopQuiz() {
        const btn = document.getElementById('btn-stop-quiz');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Dayandƒ±rƒ±lƒ±r...';
        try {
            const response = await apiFetch('/api/telegram/stop-quiz', { method: 'GET' });
            const result = await response.json();
            if (result.success) {
                alert('‚úÖ Sessiya dayandƒ±rƒ±lƒ±r.');
            } else {
                alert('‚ùå X…ôta: ' + result.message);
            }
        } catch (error) {
            console.error(error);
            alert('‚ùå Serverl…ô …ôlaq…ô qurmaq m√ºmk√ºn olmadƒ±.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    async function addQuizQuestion() {
        const question = document.getElementById('q-text').value;
        const opt0 = document.getElementById('q-opt0').value;
        const opt1 = document.getElementById('q-opt1').value;
        const opt2 = document.getElementById('q-opt2').value;
        const opt3 = document.getElementById('q-opt3').value;
        const correct = parseInt(document.getElementById('q-correct').value);
        const explanation = document.getElementById('q-explanation').value;
        const category = document.getElementById('q-category').value;
        
        const btn = document.getElementById('btn-add-question');
        const originalText = btn.innerHTML;

        if (!question || !opt0 || !opt1 || !opt2 || !opt3) {
            alert("Z…ôhm…ôt olmasa sual v…ô b√ºt√ºn variantlarƒ± doldurun.");
            return;
        }

        const newQuestion = {
            question: question,
            options: [opt0, opt1, opt2, opt3],
            correct_option_id: correct,
            explanation: explanation || "ƒ∞zah yoxdur.",
            category: category
        };

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ∆èlav…ô edilir...';

        try {
            const response = await apiFetch('/api/telegram/add-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newQuestion)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert("‚úÖ Sual bazaya …ôlav…ô edildi!");
                // Sah…ôl…ôri t…ômizl…ô
                document.getElementById('q-text').value = '';
                document.getElementById('q-opt0').value = '';
                document.getElementById('q-opt1').value = '';
                document.getElementById('q-opt2').value = '';
                document.getElementById('q-opt3').value = '';
                document.getElementById('q-explanation').value = '';
            } else {
                alert("‚ùå X…ôta: " + result.message);
            }
        } catch (error) {
            console.error(error);
            alert("‚ùå Serverl…ô …ôlaq…ô qurmaq m√ºmk√ºn olmadƒ±.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // --- SUAL AXTARI≈û V∆è D√úZ∆èLƒ∞≈û Sƒ∞STEMƒ∞ ---
    async function searchQuestion() {
        const searchText = document.getElementById('search-q-text').value.trim();
        const resultsDiv = document.getElementById('search-results');
        const btn = document.getElementById('btn-search-question');
        
        if (!searchText) {
            alert("Axtarƒ±≈ü √º√ß√ºn m…ôtn daxil edin!");
            return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Axtarƒ±lƒ±r...';
        btn.disabled = true;
        resultsDiv.innerHTML = '';

        try {
            const response = await apiFetch(`/api/admin/search-questions?q=${encodeURIComponent(searchText)}`);
            const data = await response.json();

            if (data.success) {
                const results = data.results || [];
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding:10px; color: #64748b;">He√ß bir n…ôtic…ô tapƒ±lmadƒ±.</div>';
                } else {
                    results.forEach(res => {
                        renderQuestionEditor(res.docId, res.index, res.question, res.categoryName, resultsDiv);
                    });
                }
            } else {
                throw new Error(data.message || "Axtarƒ±≈ü zamanƒ± x…ôta ba≈ü verdi.");
            }
        } catch (error) {
            console.error("Axtarƒ±≈ü x…ôtasƒ±:", error);
            alert("Axtarƒ±≈ü zamanƒ± x…ôta ba≈ü verdi: " + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Sual m…ôlumatlarƒ±nƒ± m√ºv…ôqq…ôti saxlamaq √º√ß√ºn
    const questionDataCache = {};

    function renderQuestionEditor(docId, index, q, categoryName, container) {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.border = '1px solid #e2e8f0';
        div.style.padding = '15px';
        
        // Correct index/option id handling
        let currentCorrect = 0;
        if (q.correctIndex !== undefined) currentCorrect = q.correctIndex;
        else if (q.correct_option_id !== undefined) currentCorrect = q.correct_option_id;

        const qText = q.text || q.question || "";
        const opts = q.options || ["", "", "", ""];

        // M…ôlumatƒ± ke≈üd…ô saxla
        const qKey = `${docId}_${index}`;
        questionDataCache[qKey] = {
            question: qText,
            options: opts,
            correct_option_id: currentCorrect
        };

        div.innerHTML = `
            <div style="margin-bottom:10px; font-weight:bold; color:#2563eb;">
                ${categoryName} - Sual #${index + 1}
            </div>
            <div class="form-group">
                <label>Sual:</label>
                <textarea id="edit-q-${docId}-${index}" rows="2" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px;">${qText}</textarea>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label style="font-size:0.8rem; color:#666; margin-bottom:2px;">A (Sol-Yuxarƒ±)</label><input id="edit-opt0-${docId}-${index}" value="${opts[0] || ''}" placeholder="A"></div>
                <div class="form-group"><label style="font-size:0.8rem; color:#666; margin-bottom:2px;">B (Saƒü-Yuxarƒ±)</label><input id="edit-opt1-${docId}-${index}" value="${opts[1] || ''}" placeholder="B"></div>
                <div class="form-group"><label style="font-size:0.8rem; color:#666; margin-bottom:2px;">C (Sol-A≈üaƒüƒ±)</label><input id="edit-opt2-${docId}-${index}" value="${opts[2] || ''}" placeholder="C"></div>
                <div class="form-group"><label style="font-size:0.8rem; color:#666; margin-bottom:2px;">D (Saƒü-A≈üaƒüƒ±)</label><input id="edit-opt3-${docId}-${index}" value="${opts[3] || ''}" placeholder="D"></div>
            </div>
            <div class="form-group">
                <label>D√ºzg√ºn cavab:</label>
                <select id="edit-correct-${docId}-${index}" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; background:white;">
                    <option value="0" ${currentCorrect == 0 ? 'selected' : ''}>A (Sol-Yuxarƒ±)</option>
                    <option value="1" ${currentCorrect == 1 ? 'selected' : ''}>B (Saƒü-Yuxarƒ±)</option>
                    <option value="2" ${currentCorrect == 2 ? 'selected' : ''}>C (Sol-A≈üaƒüƒ±)</option>
                    <option value="3" ${currentCorrect == 3 ? 'selected' : ''}>D (Saƒü-A≈üaƒüƒ±)</option>
                </select>
            </div>
             <div class="form-group">
                <label>ƒ∞zah:</label>
                <textarea id="edit-expl-${docId}-${index}" rows="2" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px;">${q.explanation || ""}</textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveQuestionEdit('${docId}', ${index})" class="save-btn" style="background:#059669; flex:1;">
                    <i class="fas fa-save"></i> Yadda Saxla
                </button>
                <button onclick="deleteQuestion('${docId}', ${index})" class="save-btn" style="background:#ef4444; width:120px;">
                    <i class="fas fa-trash-alt"></i> Sil
                </button>
            </div>
        `;
        container.appendChild(div);
    }

    async function saveQuestionEdit(docId, index) {
        if(!confirm("D…ôyi≈üiklikl…ôri yadda saxlamaq ist…ôdiyiniz…ô …ôminsiniz?")) return;

        const qText = document.getElementById(`edit-q-${docId}-${index}`).value;
        const opt0 = document.getElementById(`edit-opt0-${docId}-${index}`).value;
        const opt1 = document.getElementById(`edit-opt1-${docId}-${index}`).value;
        const opt2 = document.getElementById(`edit-opt2-${docId}-${index}`).value;
        const opt3 = document.getElementById(`edit-opt3-${docId}-${index}`).value;
        const correct = parseInt(document.getElementById(`edit-correct-${docId}-${index}`).value);
        const expl = document.getElementById(`edit-expl-${docId}-${index}`).value;

        try {
            const payload = {
                docId: docId,
                index: index,
                questionData: {
                    text: qText,
                    question: qText,
                    options: [opt0, opt1, opt2, opt3],
                    correctIndex: correct,
                    correct_option_id: correct,
                    explanation: expl
                }
            };

            const response = await apiFetch('/api/admin/update-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                alert("‚úÖ D√ºz…ôli≈ü yadda saxlandƒ±!");
            } else {
                throw new Error(result.message || "Nam…ôlum x…ôta");
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå X…ôta: " + e.message);
        }
    }

    async function deleteQuestion(docId, index) {
        if(!confirm("‚ö†Ô∏è Diqq…ôt! Bu sualƒ± silm…ôk ist…ôdiyiniz…ô …ôminsiniz?\n\nSual h…ôm bazadan, h…ôm d…ô Telegram botunun siyahƒ±sƒ±ndan bird…ôf…ôlik silin…ôc…ôk.")) return;

        const qKey = `${docId}_${index}`;
        const qData = questionDataCache[qKey];

        try {
            const response = await apiFetch('/api/admin/delete-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ docId, index, questionData: qData })
            });

            // Yanƒ±tƒ±n JSON olub olmadƒ±ƒüƒ±nƒ± yoxla
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const result = await response.json();
                if (result.success) {
                    alert("‚úÖ Sual uƒüurla silindi!");
                    searchQuestion();
                } else {
                    alert("‚ùå X…ôta: " + (result.message || "Nam…ôlum x…ôta"));
                }
            } else {
                // ∆èg…ôr JSON deyils…ô (m…ôs…ôl…ôn 404 HTML s…ôhif…ôsi)
                const text = await response.text();
                console.error("Server non-JSON response:", text);
                alert("‚ùå Server x…ôtasƒ±: Server d√ºzg√ºn cavab qaytarmadƒ± (b…ôlk…ô server yenid…ôn ba≈üladƒ±lmalƒ±dƒ±r?)");
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå Silinm…ô zamanƒ± x…ôta: " + e.message);
        }
    }
</script>

</body>
</html>
