<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xüsusi Sınaq İmtahanı | DİM Stili</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* DİM Style Overrides */
        body {
            background-color: #1e1e2e; /* Darker modern background */
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent global scroll */
            height: 100vh;
            color: #333;
        }

        .dim-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: #f8f9fa;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        /* Sidebar (Question Palette) */
        .dim-sidebar {
            width: 300px;
            background: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ensure full viewport height */
            padding: 0; /* Managed internally */
            overflow: hidden; /* No global scroll */
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .dim-sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            flex-shrink: 0;
            position: relative; /* For close button positioning */
        }

        /* Mobile specific elements hidden by default on desktop */
        .mobile-toggle-btn, .mobile-overlay, .mobile-close-btn { 
            display: none !important; 
        }

        .dim-sidebar-footer {
             padding: 20px;
             border-top: 2px solid #f0f0f0;
             background: white;
             display: flex;
             justify-content: center;
             flex-shrink: 0;
             margin-top: auto; /* Push to bottom if space allows */
        }
        
        .dim-sidebar-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .dim-timer {
            font-size: 1.8rem;
            font-weight: 800;
            color: #e74c3c;
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffcccc;
            margin: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.1);
            flex-shrink: 0;
        }

        .question-palette {
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            flex: 1; /* Grow to fill space */
            min-height: 0; /* Critical for nested scrolling */
            overflow-y: auto; /* Internal scroll */
            align-content: start;
            margin-bottom: 10px;
        }

        /* Target the legend div which has inline style */
        .dim-sidebar > div[style*="font-size: 0.8rem"] {
            padding: 0 20px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .q-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            color: #4b5563;
        }

        .q-btn:hover {
            background-color: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .q-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .q-btn.answered {
            background-color: #10b981;
            color: white;
            border-color: #059669;
        }

        .q-btn.flagged {
            background-color: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        /* Main Content */
        .dim-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full height */
            overflow: hidden; /* No global scroll */
            background-color: #f3f4f6;
            padding: 0; /* Remove padding from container */
        }

        .dim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin: 20px 40px; /* Margin for spacing */
            flex-shrink: 0;
            gap: 15px; /* Spacing for mobile items */
        }

        .dim-header h2 {
            margin: 0;
            color: #1f2937;
            font-size: 1.5rem;
        }

        .dim-question-area {
            width: 800px; /* Fixed Width Request */
            max-width: 90%; /* Responsive fallback */
            margin: 0 auto; /* Center horizontally */
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            
            flex: 1; /* Fill remaining vertical space */
            min-height: 0; /* Allow shrinking for scroll */
            overflow-y: auto; /* Internal Scroll */
            
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .q-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .q-text {
            font-size: 1.25rem;
            line-height: 1.8;
            margin-bottom: 30px;
            color: #1f2937;
            font-weight: 500;
        }

        .q-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .q-option {
            display: flex;
            align-items: flex-start;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .q-option:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        .q-option.selected {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .q-radio {
            margin-top: 5px;
            margin-right: 15px;
            accent-color: #3b82f6;
            transform: scale(1.2);
        }
        
        .q-option span {
            color: #1f2937 !important; /* Explicit text color for visibility */
            font-size: 1.1rem;
            line-height: 1.5;
            display: block; /* Ensure it takes space */
        }

        .dim-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            margin: 0 40px 20px 40px; /* Bottom margin */
            flex-shrink: 0; /* Keep fixed at bottom */
        }

        .btn-dim {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-prev {
            background-color: #9ca3af;
            color: white;
        }
        .btn-prev:hover { background-color: #6b7280; transform: translateY(-2px); }
        .btn-prev:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-next {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }
        .btn-next:hover { background-color: #2563eb; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(59, 130, 246, 0.3); }

        .btn-finish {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
            width: 100%; /* Full width in sidebar */
            margin-top: 10px;
            justify-content: center;
        }
        .btn-finish:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(239, 68, 68, 0.3); }

        .btn-flag {
            background-color: #f59e0b;
            color: white;
            margin-right: auto;
            margin-left: 20px;
        }
        .btn-flag:hover { background-color: #d97706; transform: translateY(-2px); }
        
        .hidden { display: none !important; }

        /* Results Screen */
        .dim-results {
            max-width: 1000px; /* More compact width */
            margin: 10px auto;
            background: white;
            padding: 20px; /* Reduced padding */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            /* Optional: transform for very small screens if needed, handled via media query usually */
        }
        
        .dim-results h2 { color: #111827 !important; }
        .dim-results p { color: #4b5563 !important; }

        .result-header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .result-header-info h4 { margin: 0; color: #1f2937; font-size: 1.2rem; }

        .result-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .result-table th, .result-table td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: center;
        }
        
        .result-table th {
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 700;
        }
        
        .result-table td {
            color: #1f2937;
        }

        .result-wrong {
            background-color: #fef2f2;
            color: #dc2626 !important;
            font-weight: 600;
        }
        
        .result-correct {
            color: #059669 !important;
            font-weight: 600;
        }

        .result-summary-footer {
            display: block; /* Stacked vertically */
            margin-top: 5px;
            padding-top: 5px;
            border-top: none;
        }
        
        .summary-item {
            text-align: center;
        }
        .summary-val { font-size: 2rem; font-weight: 800; }
        .summary-label { color: #6b7280; font-size: 0.9rem; text-transform: uppercase; }

        /* DİM Protocol Table Styles - COMPACT V3 */
        .dim-protocol-header { text-align: center; margin-bottom: 5px; }
        .dim-protocol-title { font-size: 1.1rem; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; color: #000; }
        .dim-protocol-user { font-size: 1.2rem; font-weight: 800; margin-bottom: 5px; color: #000; text-transform: uppercase; }
        .dim-protocol-meta { text-align: left; font-size: 0.8rem; color: #333; margin-bottom: 5px; font-weight: 600; }

        .dim-protocol-table-wrapper { margin-bottom: 5px; overflow-x: auto; }
        .dim-protocol-table { width: 100%; border-collapse: collapse; border: 1px solid #000; table-layout: fixed; }
        .dim-protocol-table td { 
            border: 1px solid #000; 
            text-align: center; 
            vertical-align: middle; 
            height: 20px; /* Super Compact Height */
            width: 25px; 
            padding: 0; 
            font-size: 11px; /* Super Compact Font */
            color: #000; 
        }
        
        /* First column (Headers) specific style */
        .dim-protocol-table td:first-child { width: 80px; text-align: left; padding-left: 5px; font-weight: bold; background: #fff; white-space: nowrap; font-size: 10px; }
        
        .status-plus { color: green !important; font-weight: 900; font-size: 12px; background-color: #f0fdf4; }
        .status-minus { color: red !important; font-weight: 900; font-size: 12px; background-color: #fef2f2; }

        /* New Result Elements */
        .result-stats-left {
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #000;
            margin: 5px 0;
            line-height: 1.4;
            padding-left: 5px;
        }

        .result-final-block {
            background-color: #f8d7da; /* Light red/pinkish as requested */
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .result-final-text {
            color: #721c24; /* Dark red text */
            font-weight: 900;
            font-size: 1.5rem;
            display: block;
        }

        .result-back-btn-container {
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                overflow: auto; /* Allow auto for safe fallback */
                height: auto;
                min-height: 100vh;
                min-height: 100dvh;
                -webkit-text-size-adjust: 100%; /* iOS zoom fix */
            }
            .dim-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                min-height: 100dvh;
            }

            /* MOBILE OVERLAY BACKDROP */
            .mobile-overlay {
                display: none; /* JS toggles block */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1999;
                backdrop-filter: blur(2px);
                -webkit-backdrop-filter: blur(2px);
            }
            .mobile-overlay.active { display: block !important; }

            /* SIDEBAR AS BOTTOM SHEET */
            .dim-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70vh; /* Fallback */
                height: 70dvh; /* Dynamic viewport height */
                max-height: 85vh;
                background: white;
                z-index: 2000;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
                transform: translateY(110%); /* Hidden by default */
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                display: flex;
                flex-direction: column;
                order: unset; /* Remove flex order */
                border-top: none;
                border-right: none;
                padding-bottom: env(safe-area-inset-bottom); /* iOS safe area */
            }
            .dim-sidebar.active {
                transform: translateY(0); /* Show when active */
            }

            /* Sidebar internal scroll */
            .question-palette {
                grid-template-columns: repeat(8, 1fr);
                gap: 6px;
                padding: 10px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
                flex: 1; /* Take available space */
                align-content: start;
            }

            /* Smaller buttons for mobile */
            .q-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
                margin: 0 auto;
            }

            /* MOBILE CLOSE BUTTON */
            .dim-sidebar .mobile-close-btn {
                display: block !important;
                position: absolute;
                right: 20px;
                top: 20px;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #666;
                cursor: pointer;
                padding: 5px;
            }

            /* MAIN CONTENT ADJUSTMENTS */
            .dim-main {
                height: auto;
                order: unset; /* Remove flex order */
                background: #f3f4f6;
                overflow: visible;
                width: 100%;
                padding-bottom: 90px; /* Space for footer */
            }

            /* HEADER ADJUSTMENTS */
            .dim-header {
                margin: 10px;
                padding: 12px 16px;
                flex-wrap: nowrap;
            }
            .dim-header h2 {
                font-size: 1.1rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* TOGGLE BUTTON */
            .mobile-toggle-btn {
                display: flex !important;
                align-items: center;
                gap: 8px;
                background: #3b82f6;
                color: white;
                border: none;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
                white-space: nowrap;
            }

            /* QUESTION AREA ADJUSTMENTS */
            .dim-question-area {
                width: auto;
                max-width: none;
                padding: 20px;
                margin: 0 10px 10px 10px;
                flex: 1; /* Allow growing */
            }

            /* FOOTER ADJUSTMENTS */
            .dim-footer {
                margin: 0;
                padding: 12px 16px;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: white;
                z-index: 10;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                box-sizing: border-box;
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
            
            .btn-dim {
                padding: 10px 16px;
                font-size: 0.95rem;
            }
        }
        @media (max-width: 480px) {
             /* Merged into 768px block for consistency */
        }

        @media (max-height: 900px) {
            .dim-results {
                transform: scale(0.95);
                transform-origin: top center;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

    <div id="loading-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <div class="loader"></div>
        <p style="margin-top:20px;font-size:1.2rem;color:#555;">İmtahan yüklənir...</p>
    </div>

    <!-- Exam Interface -->
    <div id="exam-interface" class="dim-container hidden">
        <!-- NEW: Overlay Backdrop -->
        <div class="mobile-overlay" onclick="document.querySelector('.dim-sidebar').classList.remove('active'); document.querySelector('.mobile-overlay').classList.remove('active');"></div>

        <!-- Left Sidebar -->
        <div class="dim-sidebar">
            <div class="dim-sidebar-header">
                <h3>Sual Paneli</h3>
                <!-- NEW: Close Button for Mobile -->
                <button class="mobile-close-btn" onclick="document.querySelector('.dim-sidebar').classList.remove('active'); document.querySelector('.mobile-overlay').classList.remove('active');">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="timer-display" class="dim-timer">00:00:00</div>
            
            <div class="question-palette" id="question-palette">
                <!-- Question buttons generated by JS -->
            </div>
            
            <div style="text-align:center; margin-bottom: 10px; font-size: 0.8rem; color: #666; display: flex; justify-content: center; gap: 10px;">
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#10b981; border-radius:2px; display:inline-block;"></span> Yazılıb</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#f59e0b; border-radius:2px; display:inline-block;"></span> Seçilib</span>
            </div>

            <div class="dim-sidebar-footer">
                <button class="btn-dim btn-finish" onclick="finishExam()"><i class="fas fa-check-circle"></i> İmtahanı Bitir</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="dim-main">
            <div class="dim-header">
                <!-- NEW: Toggle Button (Mobile Only) -->
                <button class="mobile-toggle-btn" onclick="document.querySelector('.dim-sidebar').classList.add('active'); document.querySelector('.mobile-overlay').classList.add('active');">
                    <i class="fas fa-th-large"></i> Panel
                </button>

                <h2 id="exam-title" style="font-size: 1.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Sınaq İmtahanı</h2>
                <div>
                    <i class="fas fa-user-circle"></i> <strong>İstifadəçi:</strong> <span id="user-name">Qonaq</span>
                </div>
            </div>

            <div class="dim-question-area">
                <div class="q-number" id="q-number">Sual 1</div>
                <div class="q-text" id="q-text">Sual mətni yüklənir...</div>
                
                <div class="q-options" id="q-options">
                    <!-- Options generated by JS -->
                </div>
            </div>

            <div class="dim-footer">
                <button class="btn-dim btn-prev" id="btn-prev" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> <span class="desktop-text">Əvvəlki</span></button>
                <button class="btn-dim btn-flag" onclick="toggleFlag()"><i class="fas fa-flag"></i> <span class="desktop-text">İşarələ</span></button>
                <button class="btn-dim btn-next" id="btn-next" onclick="nextQuestion()"><span class="desktop-text">Növbəti</span> <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Results Interface -->
    <div id="results-interface" class="dim-results hidden text-center">
        <!-- Header removed here as it is injected via JS now -->
        
        <div class="result-table-container">
            <!-- Tables will be inserted here -->
        </div>

        <div class="result-summary-footer hidden" style="display: none;">
            <!-- Summary will be inserted here -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script src="app.js"></script> <!-- Reusing app.js for config but we will override init -->
    <script>
        // NEW: Mobile UI Toggle Logic
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.dim-sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }
        
        // Auto-close when clicking a question in palette (Delegation)
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && e.target.closest('.q-btn')) {
                const sidebar = document.querySelector('.dim-sidebar');
                const overlay = document.querySelector('.mobile-overlay');
                if (sidebar && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    if (overlay) overlay.classList.remove('active');
                }
            }
        });

        // Override standard app initialization
        window.onload = async function() {
            // Prevent standard dashboard load
            document.body.classList.add('dim-mode'); // Optional flag
            
            // Wait for firebase
            setTimeout(initDimExam, 1000);
        };

        function __lsGet(key) {
            try { return localStorage.getItem(key); } catch (_) { return null; }
        }
        function __lsJson(key) {
            try {
                const v = __lsGet(key);
                return v ? JSON.parse(v) : null;
            } catch (_) {
                return null;
            }
        }

        let dimQuiz = {
            questions: [],
            currentIndex: 0,
            answers: [], // stores index of selected option
            flags: [],
            timerInterval: null,
            startTime: null,
            duration: 0
        };

        async function initDimExam() {
            let weeklyExamType = null;
            try {
                const sp = new URLSearchParams(window.location.search || '');
                weeklyExamType = sp.get('weeklyExamType');
            } catch(_) { weeklyExamType = null; }

            let catId = null;
            if (weeklyExamType) {
                catId = 'weekly_exam_' + String(weeklyExamType);
            } else {
                try { catId = localStorage.getItem('activeSpecialCategory'); } catch(_) { catId = null; }
            }
            if (!catId) {
                alert('İmtahan seçilməyib!');
                window.location.href = 'index.html';
                return;
            }

            // Load Category
            let cat = null;

            if (weeklyExamType) {
                if (!db) {
                    alert('Verilənlər bazası ilə əlaqə yoxdur. Səhifəni yeniləyin.');
                    window.location.href = 'index.html';
                    return;
                }
                try {
                    const docRef = db.collection('weekly_exams').doc('active_' + String(weeklyExamType));
                    const doc = await docRef.get();
                    if (!doc.exists) throw new Error("Bu kateqoriya üçün hələlik aktiv sınaq yoxdur.");
                    const data = doc.data() || {};
                    cat = {
                        id: catId,
                        name: data.name || 'Həftəlik Sınaq',
                        description: data.description || '',
                        time: 180,
                        questions: data.questions || [],
                        isSpecial: true,
                        examType: String(weeklyExamType),
                        weekId: data.weekId,
                        publishedAt: data.publishedAt
                    };
                } catch(e) {
                    alert(e && e.message ? e.message : 'Xəta baş verdi');
                    window.location.href = 'index.html';
                    return;
                }
            } else {
                // Check for generated exam
                if (catId === 'generated_prokurorluq' || catId.startsWith('weekly_exam_') || catId === 'weekly_draft_view') {
                    try {
                        const genData = localStorage.getItem('generatedExamData');
                        if (genData) cat = JSON.parse(genData);
                    } catch(e) { console.error(e); }
                }
            }

            // Normal loading
            if (!cat) {
                cat = categories.find(c => c.id === catId);
            }
            
            // If not in memory (app.js might not have loaded it yet), try to fetch or wait
            if (!cat && db) {
                try {
                    const doc = await db.collection('categories').doc(catId).get();
                    if (doc.exists) {
                        cat = { id: doc.id, ...doc.data() };
                    }
                } catch(e) { console.error(e); }
            }

            if (!cat) {
                // Try local storage fallback
                try {
                    const localCats = JSON.parse(__lsGet('categories') || '[]');
                    cat = localCats.find(c => c.id === catId);
                } catch(_) { cat = null; }
            }

            if (!cat || !cat.questions || cat.questions.length === 0) {
                alert('Sual tapılmadı!');
                window.location.href = 'index.html';
                return;
            }

            dimQuiz.meta = { catId: catId, exam: cat, weeklyExamType: weeklyExamType };

            // Initialize Quiz
            document.getElementById('exam-title').textContent = cat.name;
            const user = __lsJson('currentUser');
            if(user) document.getElementById('user-name').textContent = user.username || user.email;

            // Prepare questions (Shuffle if needed, currently taking all)
            // DİM exams usually have fixed order, but let's shuffle options maybe?
            // For now, keep order as is or shuffle questions
            
            // Filter out empty questions and clean text (UPDATED: Actually updating the object text now!)
            let processedQuestions = cat.questions
                .map(q => {
                    // Create a shallow copy to avoid mutating original data in memory if it matters,
                    // but more importantly, to ensure we have the cleaned text.
                    const newText = cleanQuestionText(q.text);
                    return { ...q, text: newText };
                })
                .filter(q => q.text && q.text.length > 5);
            
            // Shuffle if Weekly Exam (User request: same questions but random order for each user)
            if (catId && catId.includes('weekly')) {
                 processedQuestions = processedQuestions.sort(() => 0.5 - Math.random());
            }

            dimQuiz.questions = processedQuestions;
            
            dimQuiz.answers = new Array(dimQuiz.questions.length).fill(null);
            dimQuiz.flags = new Array(dimQuiz.questions.length).fill(false);
            dimQuiz.duration = (cat.time || 90) * 60; // minutes to seconds

            renderPalette();
            loadDimQuestion(0);
            startTimer();

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('exam-interface').classList.remove('hidden');
        }

        function renderPalette() {
            const p = document.getElementById('question-palette');
            p.innerHTML = '';
            dimQuiz.questions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.className = 'q-btn';
                btn.textContent = i + 1;
                btn.onclick = () => loadDimQuestion(i);
                btn.id = `pal-btn-${i}`;
                p.appendChild(btn);
            });
            updatePaletteStyles();
        }

        function updatePaletteStyles() {
            dimQuiz.questions.forEach((_, i) => {
                const btn = document.getElementById(`pal-btn-${i}`);
                if (!btn) return;
                
                btn.className = 'q-btn'; // reset
                if (i === dimQuiz.currentIndex) btn.classList.add('active');
                if (dimQuiz.answers[i] !== null) btn.classList.add('answered');
                if (dimQuiz.flags[i]) btn.classList.add('flagged');
            });
        }

        function cleanQuestionText(text) {
            if (!text) return "";
            let t = text;
            // Remove prefix like "Sual 1.", "17.", "Sual 5:", "Sual 17"
            t = t.replace(/^(Sual\s*\d*|\d+)\s*[:.]?\s*/i, '');
            
            // Remove "(Maddə ...)" at the start (e.g. "(Maddə 26: ...)")
            t = t.replace(/^\s*\(\s*Maddə\s*[^)]+\)\s*/i, '');
            // Remove "Maddə ..." at the start without parens if present
            t = t.replace(/^\s*Maddə\s*[^:.]+[.:]\s*/i, '');

            // Remove suffix like "(Maddə 7.0.35)", "(Maddə 90)", "Maddə 15", "Maddə 15."
            // Updated to be safer and avoid matching full text if it starts with Maddə
            t = t.replace(/\s*\(?\s*Maddə\s*[\d.\s\-a-z]{1,20}\)?\.?\s*$/i, '');
            
            return t.trim();
        }

        function finishExam(force = false) {
            if (!force && !confirm('İmtahanı bitirmək istədiyinizə əminsiniz?')) return;
            
            clearInterval(dimQuiz.timerInterval);
            
            // Calculate Results
            let correct = 0;
            let wrong = 0;
            let unanswered = 0;
            const optionLabels = ['A', 'B', 'C', 'D', 'E'];
            
            const questions = dimQuiz.questions;
            const answers = dimQuiz.answers;
            
            // Calculate stats
            questions.forEach((q, i) => {
                const userAns = answers[i];
                let correctIdx = q.correctIndex;
                if (correctIdx === undefined) correctIdx = q.correct;
                
                if (userAns === null) {
                    unanswered++;
                } else if (parseInt(userAns) === parseInt(correctIdx)) {
                    correct++;
                } else {
                    wrong++;
                }
            });

            // Container
            const container = document.querySelector('.result-table-container');
            container.innerHTML = ''; 
            
            // 1. Header Section
            const user = __lsJson('currentUser');
            const userName = user ? (user.username || user.email) : 'NAMİZƏD';
            const examTitle = document.getElementById('exam-title').textContent || 'SINAQ İMTAHANI';
            
            const now = new Date();
            const dateStr = `${now.getDate().toString().padStart(2,'0')}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getFullYear()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

            const headerHtml = `
                <div class="dim-protocol-header">
                    <div class="dim-protocol-title">${examTitle}</div>
                    <div class="dim-protocol-user">${userName}</div>
                    <div class="dim-protocol-meta">İmtahanın tarixi və vaxtı: ${dateStr}</div>
                </div>
            `;
            container.innerHTML = headerHtml;

            // 2. Protocol Tables (Chunks of 20)
            const chunkSize = 20;
            for (let i = 0; i < questions.length; i += chunkSize) {
                const chunk = questions.slice(i, i + chunkSize);
                
                let tableHtml = `
                    <div class="dim-protocol-table-wrapper">
                        <table class="dim-protocol-table">
                            <!-- Row 1: Numbers -->
                            <tr>
                                <td>Sual №</td>
                `;
                // Fill cells 1..20
                for(let j=0; j<chunkSize; j++) {
                    if (i+j < questions.length) tableHtml += `<td>${i+j+1}</td>`;
                    else tableHtml += `<td></td>`;
                }
                tableHtml += `</tr>`;

                // Row 2: Correct Answers
                tableHtml += `<tr><td>Doğru cavab</td>`;
                for(let j=0; j<chunkSize; j++) {
                    if (i+j < questions.length) {
                        const q = questions[i+j];
                        let cIdx = q.correctIndex !== undefined ? q.correctIndex : q.correct;
                        tableHtml += `<td style="color:red; font-weight:bold;">${optionLabels[cIdx] || ''}</td>`;
                    } else tableHtml += `<td></td>`;
                }
                tableHtml += `</tr>`;

                // Row 3: User Answers
                tableHtml += `<tr><td>Cavab</td>`;
                for(let j=0; j<chunkSize; j++) {
                    if (i+j < questions.length) {
                        const uAns = answers[i+j];
                        tableHtml += `<td>${uAns !== null ? optionLabels[uAns] : ''}</td>`;
                    } else tableHtml += `<td></td>`;
                }
                tableHtml += `</tr>`;

                // Row 4: Status (+/-)
                tableHtml += `<tr><td>Status</td>`; 
                for(let j=0; j<chunkSize; j++) {
                    if (i+j < questions.length) {
                        const q = questions[i+j];
                        const uAns = answers[i+j];
                        let cIdx = q.correctIndex !== undefined ? q.correctIndex : q.correct;
                        
                        let sym = '';
                        let cls = '';
                        if (uAns !== null) {
                            if (parseInt(uAns) === parseInt(cIdx)) {
                                sym = '+';
                                cls = 'status-plus';
                            } else {
                                sym = '-';
                                cls = 'status-minus';
                            }
                        }
                        tableHtml += `<td class="${cls}">${sym}</td>`;
                    } else tableHtml += `<td></td>`;
                }
                tableHtml += `</tr></table></div>`;
                
                container.insertAdjacentHTML('beforeend', tableHtml);
            }

            // Hide Exam, Show Results
            document.getElementById('exam-interface').classList.add('hidden');
            document.getElementById('results-interface').classList.remove('hidden');
            
            // Remove old header injection if present
            if(document.getElementById('res-user')) document.getElementById('res-user').textContent = '';
            if(document.getElementById('res-date')) document.getElementById('res-date').textContent = '';

            // 3. Summary Footer
            const summaryFooter = document.querySelector('.result-summary-footer');
            if(summaryFooter) {
                summaryFooter.classList.remove('hidden');
                summaryFooter.style.display = 'block'; // Ensure block display
                
                summaryFooter.innerHTML = `
                    <div class="result-stats-left">
                        <div>Doğru cavabların sayı: ${correct}</div>
                        <div>Yanlış cavabların sayı: ${wrong}</div>
                        <div>Cavablandırılmayan test tapşırıqlarının sayı: ${unanswered}</div>
                    </div>
                    
                    <div class="result-final-block">
                        <span class="result-final-text">YEKUN BAL: ${correct}</span>
                    </div>

                    <div class="result-back-btn-container">
                         <button class="btn-dim btn-next" onclick="window.location.href='index.html'" style="margin: 0 auto; display:inline-flex;">Əsas Səhifəyə Qayıt</button>
                    </div>
                `;
            }

            // Save attempt if user is logged in
            if (typeof currentUser !== 'undefined' && currentUser && typeof db !== 'undefined' && db) {
                 const catId = String((dimQuiz && dimQuiz.meta && dimQuiz.meta.catId) ? dimQuiz.meta.catId : (function(){ try { return localStorage.getItem('activeSpecialCategory'); } catch(_) { return ''; } })() || '');
                 let examName = document.getElementById('exam-title').textContent;
                 let weekId = null;
                 let examType = 'special_exam';

                 try {
                     const genData = (dimQuiz && dimQuiz.meta && dimQuiz.meta.exam) ? dimQuiz.meta.exam : JSON.parse(localStorage.getItem('generatedExamData') || '{}');
                     if (genData && (genData.id === catId || (catId && catId.includes('weekly')))) {
                         if (genData.name) examName = genData.name;
                         if (genData.weekId) weekId = genData.weekId;
                         if (genData.examType) examType = genData.examType;
                     }
                 } catch(e) { console.error("Error parsing generated data for save:", e); }
                 
                 db.collection('student_attempts').add({
                     userId: currentUser.id,
                     categoryId: catId,
                     examName: examName,
                     weekId: weekId,
                     score: correct,
                     total: dimQuiz.questions.length,
                     date: firebase.firestore.FieldValue.serverTimestamp(),
                     type: examType
                 }).catch(console.error);

                 // Save Exam History for Dynamic Exams (Prevent repeats)
                 // Also save for Weekly exams to track what user has seen (though weekly is fixed per week)
                 if (catId && (catId.includes('prokurorluq') || catId.includes('weekly') || catId.includes('generated'))) {
                     try {
                         if (questions.length > 0) {
                             const qIds = questions.map(q => String(q.id));
                             db.collection('exam_history').add({
                                 userId: currentUser.id,
                                 examType: examType || 'prokurorluq',
                                 questionIds: qIds,
                                 date: firebase.firestore.FieldValue.serverTimestamp()
                             }).then(() => console.log("Exam history saved."))
                              .catch(err => console.error("Error saving exam history:", err));
                        }
                    } catch (e) {
                        console.error("Error processing exam history:", e);
                    }
                }
            }
        }
        function loadDimQuestion(index) {
            if (index < 0 || index >= dimQuiz.questions.length) return;
            
            dimQuiz.currentIndex = index;
            const q = dimQuiz.questions[index];
            
            document.getElementById('q-number').textContent = `SUAL ${index + 1}`;
            document.getElementById('q-text').textContent = cleanQuestionText(q.text);
            
            const optsDiv = document.getElementById('q-options');
            optsDiv.innerHTML = '';
            
            q.options.forEach((opt, optIdx) => {
                const div = document.createElement('div');
                div.className = 'q-option';
                if (dimQuiz.answers[index] === optIdx) div.classList.add('selected');
                
                div.onclick = () => selectAnswer(optIdx);
                
                div.innerHTML = `
                    <input type="radio" name="q-opt" class="q-radio" ${dimQuiz.answers[index] === optIdx ? 'checked' : ''}>
                    <span>${escapeHtml(opt)}</span>
                `;
                optsDiv.appendChild(div);
            });

            // Update buttons
            document.getElementById('btn-prev').disabled = index === 0;
            document.getElementById('btn-next').style.display = index === dimQuiz.questions.length - 1 ? 'none' : 'inline-block';
            
            // Admin-only Edit Question button
            const footer = document.querySelector('.dim-footer');
            // Remove existing edit button if any
            const existingEditBtn = footer.querySelector('.btn-edit');
            if (existingEditBtn) existingEditBtn.remove();

            const currentUser = __lsJson('currentUser');
            if (currentUser && currentUser.role === 'admin') {
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-dim btn-edit';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Sualı Düzəlt';
                editBtn.style.marginLeft = '10px';
                editBtn.style.backgroundColor = '#ffc107'; // Warning color
                editBtn.style.color = '#000';
                editBtn.onclick = () => {
                    // Use source category if available (for weekly exams), else fallback to question's category or active exam category
                    const catId = q._sourceCategoryId || q.categoryId || (dimQuiz && dimQuiz.meta ? dimQuiz.meta.catId : null) || (function(){ try { return localStorage.getItem('activeSpecialCategory'); } catch(_) { return null; } })();
                    if (catId && q.id) {
                         window.location.href = `index.html?page=admin&adminCat=${catId}&editQuestionId=${q.id}`;
                    } else {
                        alert('Xəta: Kateqoriya və ya sual ID tapılmadı.');
                    }
                };
                footer.appendChild(editBtn);
            }

            updatePaletteStyles();
        }

        function selectAnswer(optIdx) {
            dimQuiz.answers[dimQuiz.currentIndex] = optIdx;
            
            // Visual update
            const opts = document.querySelectorAll('.q-option');
            opts.forEach((o, i) => {
                if (i === optIdx) {
                    o.classList.add('selected');
                    o.querySelector('input').checked = true;
                } else {
                    o.classList.remove('selected');
                    o.querySelector('input').checked = false;
                }
            });
            
            updatePaletteStyles();
        }

        function prevQuestion() {
            loadDimQuestion(dimQuiz.currentIndex - 1);
        }

        function nextQuestion() {
            loadDimQuestion(dimQuiz.currentIndex + 1);
        }

        function toggleFlag() {
            dimQuiz.flags[dimQuiz.currentIndex] = !dimQuiz.flags[dimQuiz.currentIndex];
            updatePaletteStyles();
        }

        function startTimer() {
            let timeLeft = dimQuiz.duration;
            const display = document.getElementById('timer-display');
            
            dimQuiz.timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(dimQuiz.timerInterval);
                    finishExam(true);
                    return;
                }
                
                const h = Math.floor(timeLeft / 3600);
                const m = Math.floor((timeLeft % 3600) / 60);
                const s = timeLeft % 60;
                
                display.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                
                // Warning color
                if (timeLeft < 300) display.style.color = 'red';
            }, 1000);
        }



        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
