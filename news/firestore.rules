rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions (Təhlükəsizlik Köməkçiləri) ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isTeacher() {
      return hasRole('teacher') || isAdmin();
    }
    
    function isModerator() {
      return hasRole('moderator') || isAdmin();
    }

    // --- 1. Users Collection (Məxfilik Qorunur) ---
    match /users/{userId} {
      // Düzəliş: İstifadəçi adı ilə giriş (username login) işləməsi üçün oxumaq icazəsi açıq olmalıdır.
      allow read: if true; 
      allow write: if isUser(userId) || isAdmin();
    }

    // --- 2. Categories (Kateqoriyalar) ---
    match /categories/{catId} {
      allow read: if true;
      allow write: if isTeacher() || isModerator();
    }

    // --- 3. Private Quizzes (Şəxsi Testlər) ---
    match /private_quizzes/{quizId} {
      allow read: if true;
      allow write: if isTeacher() || isModerator();
    }

    // --- 4. Student Attempts (Nəticələrin Məxfiliyi) ---
    match /student_attempts/{attemptId} {
      allow create: if true;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isTeacher());
      allow update, delete: if isAdmin();
    }

    // --- 5. Public Questions ---
    match /public_questions/{qId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isModerator());
    }

    // --- 6. Reports (Şikayətlər) ---
    match /reports/{reportId} {
      allow create: if true;
      allow read: if isTeacher() || isModerator();
      allow write: if isTeacher() || isModerator();
    }

    // --- 7. Discussions (Müzakirələr - SPAM Qorunması) ---
    match /discussions/{commentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isModerator());
    }

    // --- 8. Attempts (Anonim Cəhdlər) ---
    match /attempts/{attemptId} {
      allow create: if true;
      allow read: if true;
    }

    // --- 9. Settings (YENİLƏNMİŞ - API Key Qorunması və Xəbər Kateqoriyaları) ---
    
    // Xəbər kateqoriyaları üçün istisna (Hamı oxuya bilsin)
    match /settings/news_categories {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Digər bütün ayarlar (API key və s. - Yalnız müəllimlər)
    match /settings/{docId} {
      allow read: if isTeacher();
      allow write: if isAdmin();
    }
    
    // --- 10. News (YENİLƏNMİŞ HİSSƏ) ---
    match /news/{newsId} {
      // Xəbərləri hamı oxuya bilər
      allow read: if true;
      
      // Yalnız Moderatorlar yarada və silə bilər
      allow create, delete: if isModerator();

      // DİQQƏT: Baxış sayını (views) hamı artıra bilər, amma başqa şeyi dəyişə bilməzlər
      allow update: if isModerator() || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']);
    }
  }
}