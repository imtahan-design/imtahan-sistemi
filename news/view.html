<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xəbər – İmtahan Platforması</title>
  <link rel="shortcut icon" href="logo.png" type="image/png">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #e0e7ff;
      --secondary: #ec4899;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --radius: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 1rem 0;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-main);
    }
    .nav-logo-icon {
      width: 40px;
      height: 40px;
      background: var(--gradient-1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }
    .nav-logo-text h1 { font-size: 1.25rem; font-weight: 700; line-height: 1.2; }
    .nav-logo-text span { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    .nav-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .nav-btn-secondary { color: var(--text-muted); background: transparent; }
    .nav-btn-secondary:hover { color: var(--primary); background: var(--primary-light); }

    /* Article Content */
    .article-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 24px;
        background: white;
        border-radius: 24px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
    }
    .article-header { padding: 40px 0 20px; text-align: center; }
    .article-title { font-size: 2.5rem; font-weight: 800; line-height: 1.2; margin-bottom: 16px; color: var(--text-main); letter-spacing: -0.02em; }
    .article-meta { display: flex; justify-content: center; gap: 20px; color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; align-items: center; }
    .article-category { color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.85rem; margin-bottom: 10px; display: inline-block; }
    .article-image { width: 100%; height: 450px; object-fit: cover; border-radius: 16px; margin-bottom: 40px; background: #f3f4f6; box-shadow: var(--shadow-md); }
    
    .article-content { 
        font-family: 'Merriweather', serif; 
        font-size: 1.15rem; 
        line-height: 1.9; 
        color: #1f2937; 
        margin-bottom: 40px; 
    }
    .article-content p { margin-bottom: 1.5em; }
    .article-content img { max-width: 100%; border-radius: 12px; margin: 20px 0; }
    .article-content h2 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.8rem; font-family: 'Inter', sans-serif; font-weight: 700; }
    .article-content h3 { margin-top: 1.2em; margin-bottom: 0.5em; font-size: 1.5rem; font-family: 'Inter', sans-serif; font-weight: 600; }
    .article-content ul, .article-content ol { margin-bottom: 1.5em; padding-left: 1.5em; }
    .article-content blockquote { border-left: 4px solid var(--primary); padding-left: 20px; margin: 30px 0; font-style: italic; color: #4b5563; font-size: 1.25rem; background: #f9fafb; padding: 20px; border-radius: 0 12px 12px 0; }
    
    .article-tags { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); }
    .tag { background: #f3f4f6; color: #4b5563; padding: 6px 14px; border-radius: 100px; font-size: 0.9rem; text-decoration: none; transition: all 0.2s; font-family: 'Inter', sans-serif; }
    .tag:hover { background: var(--primary-light); color: var(--primary); }

    /* Share Buttons */
    .share-container {
        display: flex; gap: 12px; margin-top: 30px; justify-content: center;
    }
    .share-btn {
        width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 1px solid var(--border); background: white; color: var(--text-muted); cursor: pointer; transition: all 0.2s;
        font-size: 1.1rem;
    }
    .share-btn:hover { transform: translateY(-3px); color: var(--primary); border-color: var(--primary); }

    /* Related News */
    .related-section { max-width: 1200px; margin: 60px auto 0; padding: 0 24px; }
    .related-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 24px; border-left: 4px solid var(--primary); padding-left: 16px; }
    .related-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
    .related-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); transition: transform 0.2s; }
    .related-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    .related-img { width: 100%; height: 180px; object-fit: cover; }
    .related-content { padding: 16px; }
    .related-cat { font-size: 0.75rem; color: var(--primary); font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .related-head { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; line-height: 1.4; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .related-date { font-size: 0.8rem; color: var(--text-muted); }

    /* Footer */
    .news-footer { background: #1f2937; color: var(--text-muted); text-align: center; padding: 40px 24px; margin-top: 80px; }
    .news-footer p { color: #9ca3af; }

    @media (max-width: 768px) {
        .article-title { font-size: 2rem; }
        .article-image { height: 250px; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" class="nav-logo">
        <div class="nav-logo-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="nav-logo-text">
          <h1>İmtahan</h1>
          <span>Təhsil Platforması</span>
        </div>
      </a>
      <a href="index.html" class="nav-btn nav-btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Xəbərlərə Qayıt
      </a>
    </div>
  </nav>

  <!-- News Ticker -->
  <div class="news-ticker-container">
      <div class="ticker-label"><i class="fas fa-bolt" style="margin-right:8px;"></i> Son Xəbərlər</div>
      <div class="ticker-wrapper">
         <div class="ticker-content" id="newsTickerContent">
            <span style="padding:0 20px;">Xəbərlər yüklənir...</span>
         </div>
      </div>
  </div>

  <!-- Article Content -->
  <article class="article-container">
    <div id="loading" style="text-align: center; padding: 60px;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
        <p style="margin-top: 20px; color: var(--text-muted);">Yüklənir...</p>
    </div>
    
    <div id="articleBody" style="display: none;">
        <div class="article-header">
            <div class="article-category" id="newsCategory"></div>
            <h1 class="article-title" id="newsTitle"></h1>
            <div class="article-meta" id="newsMeta"></div>
        </div>
        
        <img id="newsCover" class="article-image" style="display: none;">
        
        <div class="article-content" id="newsContent"></div>
        
        <div class="article-tags" id="newsTags"></div>

        <div class="share-container">
            <button class="share-btn" onclick="shareArticle('facebook')" title="Facebook"><i class="fab fa-facebook-f"></i></button>
            <button class="share-btn" onclick="shareArticle('twitter')" title="Twitter"><i class="fab fa-twitter"></i></button>
            <button class="share-btn" onclick="shareArticle('linkedin')" title="LinkedIn"><i class="fab fa-linkedin-in"></i></button>
            <button class="share-btn" onclick="shareArticle('copy')" title="Linki kopyala"><i class="fas fa-link"></i></button>
        </div>
    </div>
  </article>

  <!-- Related News -->
  <section class="related-section" id="relatedSection" style="display: none;">
      <h3 class="related-title">Oxşar Xəbərlər</h3>
      <div class="related-grid" id="relatedGrid"></div>
  </section>

  <!-- Footer -->
  <footer class="news-footer">
    <div class="nav-container" style="flex-direction: column;">
      <div class="nav-logo" style="justify-content: center; margin-bottom: 20px;">
        <div class="nav-logo-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="nav-logo-text" style="text-align: left;">
          <h1 style="color: white;">İmtahan</h1>
          <span style="color: #9ca3af;">Təhsil Platforması</span>
        </div>
      </div>
      <p>&copy; 2026 İmtahan. Bütün hüquqlar qorunur.</p>
    </div>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAak_eY0WNpY7cqAEuWEBG9wBDhg1NPw_0",
        authDomain: "imtahansistemi-17659.firebaseapp.com",
        projectId: "imtahansistemi-17659",
        storageBucket: "imtahansistemi-17659.appspot.com",
        messagingSenderId: "715396853166",
        appId: "1:715396853166:web:9829b853e5e572de4d2c3f"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Helper functions (copied from news-app.js for standalone view)
    const LOCAL_NEWS_KEY = 'imtahan_news_local';
    function readLocalNews() {
        try { return JSON.parse(localStorage.getItem(LOCAL_NEWS_KEY) || '[]'); } catch { return []; }
    }
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const months = ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'İyun', 'İyul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    async function loadArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if (!id) {
            document.getElementById('loading').innerHTML = '<p style="color: red;">Xəbər tapılmadı (ID yoxdur).</p>';
            return;
        }

        const localItem = readLocalNews().find(n => n.id === id);
        if (localItem) {
            renderArticle(localItem);
            loadRelatedNews(localItem.category, localItem.id);
            loadTrendNews(localItem.id);
            return;
        }

        try {
            const doc = await db.collection('news').doc(id).get();
            let articleData = null;

            if (!doc.exists) {
                // Check initial data fallback
                const initialData = readLocalNews().find(n => n.id === id) || getInitialData().find(n => n.id === id);
                if (initialData) {
                    articleData = initialData;
                } else {
                    document.getElementById('loading').innerHTML = '<p style="color: red;">Xəbər tapılmadı.</p>';
                    return;
                }
            } else {
                articleData = { id: doc.id, ...doc.data() };
            }

            renderArticle(articleData);
            loadRelatedNews(articleData.category, articleData.id);
            loadTrendNews(articleData.id);

        } catch (error) {
            console.error("Error loading article:", error);
            // Try fallback
            const initialData = getInitialData().find(n => n.id === id);
            if (initialData) {
                renderArticle(initialData);
                loadRelatedNews(initialData.category, initialData.id);
                loadTrendNews(initialData.id);
            } else {
                document.getElementById('loading').innerHTML = `<p style="color: red;">Xəta baş verdi: ${error.message}</p>`;
            }
        }
    }

    function renderArticle(item) {
        document.title = `${item.title} – İmtahan Platforması`;
        
        document.getElementById('newsCategory').textContent = item.category;
        document.getElementById('newsTitle').textContent = item.title;
        
        document.getElementById('newsMeta').innerHTML = `
            <span><i class="far fa-calendar"></i> ${formatDate(item.date)}</span>
            <span><i class="far fa-clock"></i> ${item.readTime} dəq</span>
        `;

        if (item.imageUrl) {
            const img = document.getElementById('newsCover');
            img.src = item.imageUrl;
            img.style.display = 'block';
        }

        // Format content
        const content = item.content || item.excerpt;
        // If content is plain text (not HTML), wrap in paragraphs
        if (!content.trim().startsWith('<')) {
             document.getElementById('newsContent').innerHTML = content.split('\n').map(p => `<p>${p}</p>`).join('');
        } else {
             document.getElementById('newsContent').innerHTML = content;
        }

        if (item.tags && item.tags.length > 0) {
            const tagsContainer = document.getElementById('newsTags');
            tagsContainer.innerHTML = '';
            item.tags.forEach(tag => {
                const a = document.createElement('a');
                a.className = 'tag';
                a.href = `index.html?search=${tag}`; // Simple link back to search
                a.textContent = '#' + tag;
                tagsContainer.appendChild(a);
            });
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('articleBody').style.display = 'block';
    }

    async function loadRelatedNews(category, currentId) {
        try {
            let query = db.collection('news')
                .where('status', '==', 'published')
                .where('category', '==', category);
            let snapshot;
            try {
                snapshot = await query.orderBy('date', 'desc').limit(4).get();
            } catch (e) {
                console.warn("Index missing for related query; falling back without orderBy:", e);
                snapshot = await query.limit(4).get();
            }

            const related = [];
            snapshot.forEach(doc => {
                if (doc.id !== currentId && related.length < 3) {
                    related.push({ id: doc.id, ...doc.data() });
                }
            });

            if (related.length > 0) {
                const grid = document.getElementById('relatedGrid');
                grid.innerHTML = '';
                related.forEach(item => {
                    grid.innerHTML += `
                        <a href="view.html?id=${item.id}" class="related-card" style="text-decoration: none;">
                            <img src="${item.imageUrl || 'https://via.placeholder.com/300'}" class="related-img" onerror="this.src='https://via.placeholder.com/300'">
                            <div class="related-content">
                                <span class="related-cat">${item.category}</span>
                                <h4 class="related-head">${item.title}</h4>
                                <span class="related-date"><i class="far fa-calendar"></i> ${formatDate(item.date)}</span>
                            </div>
                        </a>
                    `;
                });
                document.getElementById('relatedSection').style.display = 'block';
            }
        } catch (e) {
            console.warn("Related news error:", e);
        }
    }

    async function loadTrendNews(currentId) {
        try {
            let query = db.collection('news').where('status', '==', 'published');
            let snapshot;
            try {
                snapshot = await query.orderBy('date', 'desc').limit(10).get();
            } catch (e) {
                console.warn("Index missing for trend query; falling back without orderBy:", e);
                snapshot = await query.limit(10).get();
            }

            let all = [];
            snapshot.forEach(doc => {
                all.push({ id: doc.id, ...doc.data() });
            });

            const local = readLocalNews();
            const existing = new Set(all.map(n => n.id));
            const merged = [...local.filter(n => !existing.has(n.id)), ...all];

            // Render Ticker with all latest news
            renderTicker(merged);

            // Filter for trends (exclude current)
            const trendItems = merged.filter(item => item.id !== currentId);

            // Shuffle and pick 3
            trendItems.sort(() => 0.5 - Math.random());
            const trends = trendItems.slice(0, 3);

            if (trends.length > 0) {
                const grid = document.getElementById('trendGrid');
                if (grid) {
                    grid.innerHTML = '';
                    trends.forEach(item => {
                        grid.innerHTML += `
                            <a href="view.html?id=${item.id}" class="related-card" style="text-decoration: none;">
                                <img src="${item.imageUrl || 'https://via.placeholder.com/300'}" class="related-img" onerror="this.src='https://via.placeholder.com/300'">
                                <div class="related-content">
                                    <span class="related-cat" style="color: var(--secondary);">${item.category}</span>
                                    <h4 class="related-head">${item.title}</h4>
                                    <span class="related-date"><i class="far fa-eye"></i> Çox oxunan</span>
                                </div>
                            </a>
                        `;
                    });
                    document.getElementById('trendSection').style.display = 'block';
                }
            }
        } catch (e) {
            console.warn("Trend news error:", e);
            // Fallback for trends
            const allInitial = getInitialData();
            renderTicker(allInitial); // Fallback ticker
            
            const trends = allInitial.slice(0, 3);
            const grid = document.getElementById('trendGrid');
            if (grid) {
                grid.innerHTML = '';
                trends.forEach(item => {
                    grid.innerHTML += `
                         <a href="view.html?id=${item.id}" class="related-card" style="text-decoration: none;">
                            <img src="${item.imageUrl || 'https://via.placeholder.com/300'}" class="related-img" onerror="this.src='https://via.placeholder.com/300'">
                            <div class="related-content">
                                <span class="related-cat" style="color: var(--secondary);">${item.category}</span>
                                <h4 class="related-head">${item.title}</h4>
                                <span class="related-date"><i class="far fa-eye"></i> Çox oxunan</span>
                            </div>
                        </a>
                    `;
                });
                document.getElementById('trendSection').style.display = 'block';
            }
        }
    }

    function renderTicker(news) {
        const tickerContent = document.getElementById('newsTickerContent');
        if (!tickerContent) return;

        if (!news || news.length === 0) {
            tickerContent.innerHTML = '';
            return;
        }

        let itemsToRender = news.slice(0, 10);
        if (itemsToRender.length < 5) {
            itemsToRender = [...itemsToRender, ...itemsToRender, ...itemsToRender];
        }

        tickerContent.innerHTML = itemsToRender.map(item => `
            <a href="view.html?id=${item.id}" class="ticker-item">
                ${item.category ? `<span style="color:var(--secondary); font-weight:bold; margin-right:5px;">[${item.category.toUpperCase()}]</span>` : ''}
                ${escapeHtml(item.title)}
            </a>
        `).join('');
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function shareArticle(platform) {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        
        let shareUrl = '';
        if (platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        if (platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
        if (platform === 'linkedin') shareUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}`;
        
        if (platform === 'copy') {
            navigator.clipboard.writeText(window.location.href);
            alert('Link kopyalandı!');
            return;
        }
        
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }

    function getInitialData() {
        return [
            {
                id: '1',
                title: 'Yeni Tədris Proqramı Təsdiqləndi',
                excerpt: 'Təhsil Nazirliyi tərəfindən təsdiqlənmiş yeni kurikulum standartları...',
                content: 'Tam mətn buradadır...',
                category: 'rəsmi',
                date: '2026-01-05',
                readTime: 3,
                imageUrl: ''
            }
            // ... truncated for brevity
        ];
    }

    document.addEventListener('DOMContentLoaded', loadArticle);
  </script>
</body>
</html>
