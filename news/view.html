<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xəbər – İmtahan Platforması</title>
  <link rel="shortcut icon" href="logo.png" type="image/png">
  <link rel="icon" href="/assets/logo.png" type="image/png" sizes="32x32">
  <link rel="icon" href="/assets/logo.png" type="image/png" sizes="16x16">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #e0e7ff;
      --secondary: #ec4899;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --radius: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 100;
      padding: 1rem 0;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-main);
    }
    .nav-logo-icon {
      width: 40px;
      height: 40px;
      background: var(--gradient-1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }
    .nav-logo-text h1 { font-size: 1.25rem; font-weight: 700; line-height: 1.2; }
    .nav-logo-text span { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    .nav-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .nav-btn-secondary { color: var(--text-muted); background: transparent; }
    .nav-btn-secondary:hover { color: var(--primary); background: var(--primary-light); }
    .nav-links { display: flex; gap: 8px; }
    .nav-links a { text-decoration: none; }

    /* Layout Grid */
    .page-layout {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 24px;
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
        align-items: start;
    }

    /* Article Content */
    .article-container {
        width: 100%;
        background: white;
        border-radius: 24px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
    }
    .article-header { padding: 40px 0 20px; text-align: center; }
    .article-title { font-size: 2.5rem; font-weight: 800; line-height: 1.2; margin-bottom: 16px; color: var(--text-main); letter-spacing: -0.02em; padding: 0 20px; }
    .article-meta { display: flex; justify-content: center; gap: 20px; color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; align-items: center; }
    .article-category { color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.85rem; margin-bottom: 10px; display: inline-block; }
    .article-image { width: 100%; height: 450px; object-fit: cover; border-radius: 16px; margin-bottom: 40px; background: #f3f4f6; box-shadow: var(--shadow-md); }
    
    .article-content { 
        font-family: 'Merriweather', serif; 
        font-size: 1.15rem; 
        line-height: 1.9; 
        color: #1f2937; 
        margin-bottom: 40px; 
        padding: 0 40px;
    }

    /* Sidebar */
    .sidebar {
        position: sticky;
        top: 100px;
    }
    
    .sidebar-widget {
        background: white;
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border);
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }
    
    .widget-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--bg-body);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .widget-title i { color: var(--primary); }
    
    .mini-card {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s;
    }
    .mini-card:last-child { margin-bottom: 0; }
    .mini-card:hover { transform: translateX(5px); }
    .mini-card:hover .mini-head { color: var(--primary); }
    
    .mini-img {
        width: 80px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg-body);
        flex-shrink: 0;
    }
    
    .mini-content { flex: 1; }
    .mini-cat { font-size: 0.7rem; color: var(--primary); font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .mini-head { font-size: 0.9rem; font-weight: 600; line-height: 1.4; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; transition: color 0.2s; }
    .mini-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: block; }

    /* Related News */
    .related-section { 
        margin-top: 40px; 
        padding: 0 40px 40px; 
    }
    
    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive columns */
        gap: 20px;
    }
    
    .related-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .related-img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: #eee;
    }
    .related-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
    .related-cat { color: var(--primary); font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .related-head { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; line-height: 1.4; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .related-date { color: var(--text-muted); font-size: 0.85rem; margin-top: auto; }

    @media (max-width: 1024px) {
        .page-layout { grid-template-columns: 1fr; }
        .sidebar { position: static; margin-top: 40px; }
        .article-content { padding: 0 24px; }
        .related-section { padding: 0 24px 40px; }
        /* Fix overflow on mobile */
        .related-grid {
             grid-template-columns: 1fr; /* Single column on mobile */
        }
        .related-card {
            display: flex; /* Horizontal card on mobile for better space usage */
            height: auto;
            align-items: center;
        }
        .related-img {
            width: 100px;
            height: 100px;
            min-width: 100px;
        }
    }

    .article-content p { margin-bottom: 1.5em; }
    .article-content img { max-width: 100%; border-radius: 12px; margin: 20px 0; }
    .article-content h2 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.8rem; font-family: 'Inter', sans-serif; font-weight: 700; }
    .article-content h3 { margin-top: 1.2em; margin-bottom: 0.5em; font-size: 1.5rem; font-family: 'Inter', sans-serif; font-weight: 600; }
    .article-content ul, .article-content ol { margin-bottom: 1.5em; padding-left: 1.5em; }
    .article-content blockquote { border-left: 4px solid var(--primary); padding-left: 20px; margin: 30px 0; font-style: italic; color: #4b5563; font-size: 1.25rem; background: #f9fafb; padding: 20px; border-radius: 0 12px 12px 0; }
    
    .article-tags { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); }
    .tag { background: #f3f4f6; color: #4b5563; padding: 6px 14px; border-radius: 100px; font-size: 0.9rem; text-decoration: none; transition: all 0.2s; font-family: 'Inter', sans-serif; }
    .tag:hover { background: var(--primary-light); color: var(--primary); }

    /* Share Buttons */
    .share-container {
        display: flex; gap: 12px; margin-top: 30px; justify-content: center;
    }
    .share-btn {
        width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 1px solid var(--border); background: white; color: var(--text-muted); cursor: pointer; transition: all 0.2s;
        font-size: 1.1rem;
    }
    .share-btn:hover { transform: translateY(-3px); color: var(--primary); border-color: var(--primary); }

    /* Footer */
    .news-footer { background: #1f2937; color: var(--text-muted); text-align: center; padding: 40px 24px; margin-top: 80px; }
    .news-footer p { color: #9ca3af; }

    /* News Ticker */
    .news-ticker-container {
        background: #1f2937;
        color: white;
        display: flex;
        align-items: center;
        overflow: hidden;
        height: 40px;
        position: relative;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .ticker-label {
        background: #ef4444;
        color: white;
        padding: 0 16px;
        height: 100%;
        display: flex;
        align-items: center;
        font-weight: 700;
        font-size: 0.85rem;
        z-index: 2;
        box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        white-space: nowrap;
        text-transform: uppercase;
    }

    .ticker-wrapper {
        flex: 1;
        overflow: hidden;
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }

    .ticker-content {
        display: flex;
        white-space: nowrap;
        animation: ticker-scroll 40s linear infinite;
        padding-left: 20px;
    }

    .ticker-item {
        display: inline-block;
        padding: 0 20px;
        font-size: 0.9rem;
        color: #e5e7eb;
        text-decoration: none;
        transition: color 0.2s;
        border-right: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }

    .ticker-item:hover {
        color: #ef4444;
    }

    .ticker-wrapper:hover .ticker-content {
        animation-play-state: paused;
    }

    @keyframes ticker-scroll {
        0% { transform: translate3d(0, 0, 0); }
        100% { transform: translate3d(-50%, 0, 0); }
    }

    @media (max-width: 768px) {
        /* Navbar Mobile */
        .nav-container { padding: 0 16px; }
        .nav-logo-text h1 { font-size: 1rem; }
        .nav-logo-text span { display: none; }
        .nav-logo-icon { width: 32px; height: 32px; font-size: 1rem; }
        #user-name { display: none !important; }
        .nav-btn { padding: 6px 12px; font-size: 0.85rem; }

        /* Article Mobile */
        .article-title { font-size: 1.8rem; padding: 0 10px; }
        .article-image { height: 250px; }
        .article-content { padding: 0 16px; font-size: 1rem; }
        .article-meta { flex-direction: column; gap: 8px; }

        /* Ticker Mobile */
        .news-ticker-container { height: 50px; flex-direction: row; }
        .ticker-label { display: none !important; }
        .ticker-wrapper { height: 100%; width: 100%; background: #1f2937; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="/news/index.html" class="nav-logo">
        <div class="nav-logo-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="nav-logo-text">
          <h1>İmtahan Xəbər</h1>
          <span>Təhsil Platforması</span>
        </div>
      </a>
      
      <div class="nav-links">
        <a href="index.html" class="nav-btn nav-btn-secondary">Ana Səhifə</a>
      </div>
    </div>
  </nav>

  <!-- News Ticker -->
  <div class="news-ticker-container">
      <div class="ticker-label"><i class="fas fa-bolt" style="margin-right:8px;"></i> Son Xəbərlər</div>
      <div class="ticker-wrapper">
         <div class="ticker-content" id="newsTickerContent">
            <span style="padding:0 20px;">Xəbərlər yüklənir...</span>
         </div>
      </div>
  </div>

  <!-- Main Content Layout -->
  <div class="page-layout">
    <!-- Left Column: Article -->
    <article class="article-container">
        <div id="loading" style="text-align: center; padding: 60px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
            <p style="margin-top: 20px; color: var(--text-muted);">Yüklənir...</p>
        </div>
        
        <div id="articleBody" style="display: none;">
            <div class="article-header">
                <div class="article-category" id="newsCategory"></div>
                <h1 class="article-title" id="newsTitle"></h1>
                <div class="article-meta" id="newsMeta"></div>
            </div>
            
            <img id="newsCover" class="article-image" style="display: none;">
            
            <div class="article-content" id="newsContent"></div>
            
            <div class="article-tags" id="newsTags"></div>

            <div class="share-container">
                <button class="share-btn" onclick="shareArticle('facebook')" title="Facebook"><i class="fab fa-facebook-f"></i></button>
                <button class="share-btn" onclick="shareArticle('twitter')" title="Twitter"><i class="fab fa-twitter"></i></button>
                <button class="share-btn" onclick="shareArticle('linkedin')" title="LinkedIn"><i class="fab fa-linkedin-in"></i></button>
                <button class="share-btn" onclick="shareArticle('copy')" title="Linki kopyala"><i class="fas fa-link"></i></button>
            </div>
        </div>

        <!-- Related News (Inside Card) -->
        <section class="related-section" id="relatedSection" style="display: none; border-top: 1px solid var(--border); padding-top: 40px;">
            <h3 class="related-title">Oxşar Xəbərlər</h3>
            <div class="related-grid" id="relatedGrid"></div>
        </section>
    </article>

    <!-- Right Column: Sidebar -->
    <aside class="sidebar">
        <!-- Trend News Widget -->
        <div class="sidebar-widget" id="trendSection" style="display: none;">
            <h3 class="widget-title"><i class="fas fa-fire"></i> Çox Oxunanlar</h3>
            <div id="trendGrid">
                <!-- Trend items injected here -->
            </div>
        </div>

        <!-- Latest News Widget (Optional/Static for now) -->
        <!-- Categories Widget Removed -->
    </aside>
  </div>

  <!-- Footer -->
  <footer class="news-footer">
    <div class="nav-container" style="flex-direction: column;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
        <div class="nav-logo-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
          <i class="fas fa-newspaper"></i>
        </div>
        <div class="nav-logo-text" style="text-align: left;">
          <h1 style="color: white;">İmtahan</h1>
          <span style="color: #9ca3af;">Təhsil Platforması</span>
        </div>
      </div>
      <div style="margin-bottom: 20px;">
          <a href="https://www.instagram.com/ixeberler" target="_blank" style="color: #e1306c; text-decoration: none; font-size: 1.1rem; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 50px; transition: background 0.2s;">
              <i class="fab fa-instagram" style="font-size: 1.3rem;"></i> ixeberler
          </a>
      </div>
      <p>&copy; 2026 İmtahan. Bütün hüquqlar qorunur.</p>
    </div>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAak_eY0WNpY7cqAEuWEBG9wBDhg1NPw_0",
        authDomain: "imtahansistemi-17659.firebaseapp.com",
        projectId: "imtahansistemi-17659",
        storageBucket: "imtahansistemi-17659.appspot.com",
        messagingSenderId: "715396853166",
        appId: "1:715396853166:web:9829b853e5e572de4d2c3f"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Helper functions (copied from news-app.js for standalone view)
    const LOCAL_NEWS_KEY = 'imtahan_news_local';
    function readLocalNews() {
        try { return JSON.parse(localStorage.getItem(LOCAL_NEWS_KEY) || '[]'); } catch { return []; }
    }
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const months = ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'İyun', 'İyul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }
    function buildDescription(item) {
        var t = item.excerpt || item.content || '';
        var s = t.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
        if (s.length > 180) s = s.slice(0, 180);
        return s;
    }
    function setMetaName(name, content) {
        var m = document.querySelector('meta[name="' + name + '"]');
        if (!m) {
            m = document.createElement('meta');
            m.setAttribute('name', name);
            document.head.appendChild(m);
        }
        m.setAttribute('content', content || '');
    }
    function setMetaProp(prop, content) {
        var m = document.querySelector('meta[property="' + prop + '"]');
        if (!m) {
            m = document.createElement('meta');
            m.setAttribute('property', prop);
            document.head.appendChild(m);
        }
        m.setAttribute('content', content || '');
    }
    function setLinkRel(rel, href) {
        var l = document.querySelector('link[rel="' + rel + '"]');
        if (!l) {
            l = document.createElement('link');
            l.setAttribute('rel', rel);
            document.head.appendChild(l);
        }
        l.setAttribute('href', href || '');
    }
    function setJsonLd(data) {
        var s = document.querySelector('script[type="application/ld+json"]');
        if (!s) {
            s = document.createElement('script');
            s.type = 'application/ld+json';
            document.head.appendChild(s);
        }
        s.textContent = JSON.stringify(data);
    }
    function setSeoTags(item) {
        var url = window.location.href;
        var desc = buildDescription(item);
        var image = (item.imageUrl && /^https?:\/\//.test(item.imageUrl)) ? item.imageUrl : 'https://imtahan.site/assets/logo.png';
        setMetaName('description', desc);
        if (item.tags && item.tags.length) setMetaName('keywords', item.tags.join(','));
        setMetaProp('og:type', 'article');
        setMetaProp('og:url', url);
        setMetaProp('og:title', item.title || '');
        setMetaProp('og:description', desc);
        setMetaProp('og:image', image);
        setMetaName('twitter:card', 'summary_large_image');
        setMetaName('twitter:url', url);
        setMetaName('twitter:title', item.title || '');
        setMetaName('twitter:description', desc);
        setMetaName('twitter:image', image);
        setLinkRel('canonical', url);
        var jsonLd = {
            "@context": "https://schema.org",
            "@type": "NewsArticle",
            "headline": item.title || '',
            "image": [image],
            "datePublished": item.date ? new Date(item.date).toISOString() : new Date().toISOString(),
            "dateModified": new Date().toISOString(),
            "author": {"@type": "Organization", "name": "İmtahan"},
            "publisher": {"@type": "Organization", "name": "İmtahan", "logo": {"@type": "ImageObject", "url": "https://imtahan.site/assets/logo.png"}},
            "description": desc,
            "mainEntityOfPage": {"@type": "WebPage", "@id": url}
        };
        setJsonLd(jsonLd);
    }

    async function loadArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        let id = urlParams.get('id');
        let slug = urlParams.get('slug'); // Get slug from query parameter (from 404 redirect)
        
        // If no explicit params, check URL path for direct slug access (local dev or supported server)
        if (!id && !slug) {
            const parts = window.location.pathname.split('/');
            const last = parts[parts.length - 1];
            if (last && last !== 'view.html' && last !== 'index.html') {
                slug = last;
            }
        }
        
        // If we have a slug but no ID, try to find the ID first
        if (slug && !id) {
            // Update URL to look pretty if it's currently ugly (e.g. view.html?slug=...)
            // This is purely visual for the user after the 404 redirect
            if (window.history && window.history.replaceState && window.location.protocol !== 'file:') {
                // If we are at view.html?slug=xyz, we want to show /news/xyz
                // But we must be careful not to trigger a reload or 404 loop if user refreshes
                // Actually, for static hosting, we can't really change the URL to /news/slug 
                // because a refresh would hit 404 again (which is fine, it redirects back).
                // So let's make it look nice:
                const cleanSlug = slug.split('?')[0]; // simple cleanup
                const newPath = '/news/' + cleanSlug;
                // Only replace if we are not already there
                if (window.location.pathname !== newPath) {
                   window.history.replaceState({path: newPath}, '', newPath);
                }
            }
        }

        // Increment view count moved to after ID resolution


        // 1. Try Local Storage (Legacy/Fallback)
        let localItem = id ? readLocalNews().find(n => n.id === id) : null;

        // 2. Try Session Storage (Shared with Index)
        if (!localItem) {
            try {
                const sessionCache = sessionStorage.getItem('news_list_cache');
                if (sessionCache) {
                    const parsed = JSON.parse(sessionCache);
                    // Check timestamp if needed, but for single article view, stale data is better than read
                    localItem = id ? parsed.data.find(n => n.id === id) : (slug ? parsed.data.find(n => n.slug === slug) : null);
                }
            } catch (e) { console.warn("Session cache read error", e); }
        }

        if (localItem) {
            renderArticle(localItem);
            loadRelatedNews(localItem.category, localItem.id);
            loadTrendNews(localItem.id);
            // Cache tapılsa belə, serverdən yenilənmiş məlumatı (baxış sayını) gətirmək üçün davam edirik.
        }

        try {
            let articleData = null;
            if (slug && !id) {
                const snap = await db.collection('news').where('slug','==',slug).limit(1).get();
                if (!snap.empty) {
                    const d = snap.docs[0];
                    id = d.id;
                    articleData = { id: d.id, ...d.data() };
                }
            }
            let doc = null;
            if (!articleData && id) {
                doc = await db.collection('news').doc(id).get();
            }

            if (!articleData && doc && !doc.exists) {
                // Check initial data fallback
                const initialData = readLocalNews().find(n => n.id === id) || getInitialData().find(n => n.id === id);
                if (initialData) {
                    articleData = initialData;
                } else {
                    document.getElementById('loading').innerHTML = '<p style="color: red;">Xəbər tapılmadı.</p>';
                    return;
                }
            } else if (!articleData && doc && doc.exists) {
                articleData = { id: doc.id, ...doc.data() };
            }

            // Fix for 0 views: Increment view count now that we have the ID
            if (articleData && articleData.id) {
                 try {
                     db.collection('news').doc(articleData.id).update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                    // Optimistic update for UI
                    articleData.views = (articleData.views || 0) + 1;
                 } catch(e) { console.error("View increment error", e); }
            }

            renderArticle(articleData);
            loadRelatedNews(articleData.category, articleData.id);
            loadTrendNews(articleData.id);

        } catch (error) {
            console.error("Error loading article:", error);
            // Try fallback
            const initialData = getInitialData().find(n => n.id === id);
            if (initialData) {
                renderArticle(initialData);
                loadRelatedNews(initialData.category, initialData.id);
                loadTrendNews(initialData.id);
            } else {
                document.getElementById('loading').innerHTML = `<p style="color: red;">Xəta baş verdi: ${error.message}</p>`;
            }
        }
    }

    function renderArticle(item) {
        document.title = `${item.title} – İmtahan Platforması`;
        setSeoTags(item);
        
        document.getElementById('newsCategory').textContent = item.category;
        document.getElementById('newsTitle').textContent = item.title;
        
        document.getElementById('newsMeta').innerHTML = `
            <span><i class="far fa-calendar"></i> ${formatDate(item.date)}</span>
            <span><i class="far fa-clock"></i> ${item.readTime} dəq</span>
            <span><i class="far fa-eye"></i> ${item.views || 0}</span>
        `;

        if (item.imageUrl) {
            const img = document.getElementById('newsCover');
            img.src = item.imageUrl;
            img.style.display = 'block';
        }

        // Format content
        const content = item.content || item.excerpt;
        // If content is plain text (not HTML), wrap in paragraphs
        if (!content.trim().startsWith('<')) {
             document.getElementById('newsContent').innerHTML = content.split('\n').map(p => `<p>${p}</p>`).join('');
        } else {
             document.getElementById('newsContent').innerHTML = content;
        }

        // Tags rendering
        const tagsContainer = document.getElementById('newsTags');
        if (item.tags && item.tags.length > 0) {
            tagsContainer.innerHTML = item.tags.map(tag => `<span class="tag">#${tag}</span>`).join('');
            tagsContainer.style.display = 'flex';
        } else {
            tagsContainer.style.display = 'none';
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('articleBody').style.display = 'block';
    }

    async function loadRelatedNews(category, currentId) {
        try {
            // CACHE: Oxşar xəbərləri cache-dən oxuyaq
            const CACHE_KEY = `related_news_${category}`;
            const cached = sessionStorage.getItem(CACHE_KEY);
            let related = [];

            if (cached) {
                const parsed = JSON.parse(cached);
                // 30 dəqiqəlik cache
                if (Date.now() - parsed.timestamp < 30 * 60 * 1000) {
                    related = parsed.data;
                }
            }

            if (related.length === 0) {
                let query = db.collection('news')
                    .where('status', '==', 'published')
                    .where('category', '==', category);
                let snapshot;
                try {
                    snapshot = await query.orderBy('date', 'desc').limit(4).get();
                } catch (e) {
                    console.warn("Index missing for related query; falling back without orderBy:", e);
                    snapshot = await query.limit(4).get();
                }

                snapshot.forEach(doc => {
                    related.push({ id: doc.id, ...doc.data() });
                });

                // Save to cache
                if (related.length > 0) {
                    sessionStorage.setItem(CACHE_KEY, JSON.stringify({
                        timestamp: Date.now(),
                        data: related
                    }));
                }
            }

            // Filter out current article
            const filteredRelated = related.filter(item => item.id !== currentId).slice(0, 3);

            if (filteredRelated.length > 0) {
                const grid = document.getElementById('relatedGrid');
                grid.innerHTML = '';
                filteredRelated.forEach(item => {
                    grid.innerHTML += `
                        <a href="view.html?id=${item.id}" class="related-card" style="text-decoration: none;">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="related-img" onerror="this.insertAdjacentHTML('beforebegin','<div class=&quot;related-img&quot; style=&quot;background: var(--gradient-1)&quot;></div>'); this.remove();">` : `<div class="related-img" style="background: var(--gradient-1)"></div>`}
                            <div class="related-content">
                                <span class="related-cat">${item.category}</span>
                                <h4 class="related-head">${item.title}</h4>
                                <span class="related-date"><i class="far fa-calendar"></i> ${formatDate(item.date)}</span>
                            </div>
                        </a>
                    `;
                });
                document.getElementById('relatedSection').style.display = 'block';
            }
        } catch (e) {
            console.warn("Related news error:", e);
        }
    }

    async function loadTrendNews(currentId) {
        try {
            // CACHE: Trend xəbərləri sessiya yaddaşından oxuyaq ki, hər səhifədə sorğu getməsin
            const CACHE_KEY = 'trend_news_cache';
            const cached = sessionStorage.getItem(CACHE_KEY);
            let all = [];

            if (cached) {
                const parsed = JSON.parse(cached);
                // 15 dəqiqəlik cache
                if (Date.now() - parsed.timestamp < 15 * 60 * 1000) {
                    all = parsed.data;
                }
            }

            if (all.length === 0) {
                let query = db.collection('news').where('status', '==', 'published');
                let snapshot;
                try {
                    // Limit 10 to reduce reads
                    snapshot = await query.orderBy('date', 'desc').limit(10).get();
                } catch (e) {
                    console.warn("Index missing for trend query; falling back without orderBy:", e);
                    snapshot = await query.limit(10).get();
                }

                snapshot.forEach(doc => {
                    all.push({ id: doc.id, ...doc.data() });
                });

                // Save to cache
                if (all.length > 0) {
                    sessionStorage.setItem(CACHE_KEY, JSON.stringify({
                        timestamp: Date.now(),
                        data: all
                    }));
                }
            }

            const local = readLocalNews();
            const existing = new Set(all.map(n => n.id));
            const merged = [...local.filter(n => !existing.has(n.id)), ...all];

            // Render Ticker with all latest news
            renderTicker(merged);

            // Filter for trends (exclude current)
            const trendItems = merged.filter(item => item.id !== currentId);

            // Shuffle and pick 3
            trendItems.sort(() => 0.5 - Math.random());
            const trends = trendItems.slice(0, 3);

            if (trends.length > 0) {
                const grid = document.getElementById('trendGrid');
                if (grid) {
                    grid.innerHTML = '';
                    trends.forEach(item => {
                        grid.innerHTML += `
                            <a href="view.html?id=${item.id}" class="mini-card">
                                ${item.imageUrl ? `<img src="${item.imageUrl}" class="mini-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxIiBoZWlnaHQ9IjEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiM2MzY2ZjEiLz48L3N2Zz4='">` : `<div class="mini-img" style="background: var(--gradient-1)"></div>`}
                                <div class="mini-content">
                                    <span class="mini-cat">${item.category}</span>
                                    <h4 class="mini-head">${item.title}</h4>
                                    <span class="mini-date"><i class="far fa-eye"></i> Çox oxunan</span>
                                </div>
                            </a>
                        `;
                    });
                    document.getElementById('trendSection').style.display = 'block';
                }
            }
        } catch (e) {
            console.warn("Trend news error:", e);
            // Fallback for trends
            const allInitial = getInitialData();
            renderTicker(allInitial); // Fallback ticker
            
            const trends = allInitial.slice(0, 3);
            const grid = document.getElementById('trendGrid');
            if (grid) {
                grid.innerHTML = '';
                trends.forEach(item => {
                    grid.innerHTML += `
                            <a href="view.html?id=${item.id}" class="mini-card">
                                ${item.imageUrl ? `<img src="${item.imageUrl}" class="mini-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxIiBoZWlnaHQ9IjEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiM2MzY2ZjEiLz48L3N2Zz4='">` : `<div class="mini-img" style="background: var(--gradient-1)"></div>`}
                                <div class="mini-content">
                                    <span class="mini-cat">${item.category}</span>
                                    <h4 class="mini-head">${item.title}</h4>
                                    <span class="mini-date"><i class="far fa-eye"></i> Çox oxunan</span>
                                </div>
                            </a>
                    `;
                });
                document.getElementById('trendSection').style.display = 'block';
            }
        }
    }

    function renderTicker(news) {
        const tickerContent = document.getElementById('newsTickerContent');
        if (!tickerContent) return;

        if (!news || news.length === 0) {
            tickerContent.innerHTML = '';
            return;
        }

        let itemsToRender = news.slice(0, 10);
        if (itemsToRender.length < 5) {
            itemsToRender = [...itemsToRender, ...itemsToRender, ...itemsToRender];
        }

        const itemsHtml = itemsToRender.map(item => `
            <a href="view.html?id=${item.id}" class="ticker-item">
                ${item.category ? `<span style="color:var(--secondary); font-weight:bold; margin-right:5px;">[${item.category.toUpperCase()}]</span>` : ''}
                ${escapeHtml(item.title)}
            </a>
        `).join('');

        // Double content for seamless loop
        tickerContent.innerHTML = itemsHtml + itemsHtml;

        // Apply CSS Animation
        tickerContent.style.display = 'flex';
        tickerContent.style.width = 'max-content';
        tickerContent.style.animation = 'none'; 
        tickerContent.offsetHeight; // Reflow
        tickerContent.style.animation = 'ticker-scroll 40s linear infinite';
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function shareArticle(platform) {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        
        let shareUrl = '';
        if (platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        if (platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
        if (platform === 'linkedin') shareUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}`;
        
        if (platform === 'copy') {
            navigator.clipboard.writeText(window.location.href);
            alert('Link kopyalandı!');
            return;
        }
        
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }

    function getInitialData() {
        return [
            {
                id: '1',
                title: 'Yeni Tədris Proqramı Təsdiqləndi',
                excerpt: 'Təhsil Nazirliyi tərəfindən təsdiqlənmiş yeni kurikulum standartları...',
                content: 'Tam mətn buradadır...',
                category: 'rəsmi',
                date: '2026-01-05',
                readTime: 3,
                imageUrl: ''
            }
            // ... truncated for brevity
        ];
    }

    document.addEventListener('DOMContentLoaded', loadArticle);
  </script>
</body>
</html>
